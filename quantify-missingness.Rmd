---
title: "Missingness analysis"
author: Amelia Tan, Arianna Dagliati, Trang Le, Emily Getzen
date: "29 July 2021"
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, output_dir = "htmls") })
---
```{r setup}
source("R/utils.R")
required_pkgs <- c("tidyverse", "lubridate", "ggridges", "cowplot", "naniar", "DT","RColorBrewer","mSTEM")
install_required(required_pkgs)

library(tidyverse)
library(DT)
library(lubridate)
library(naniar)
library(cowplot)
library(ggridges)
library(RColorBrewer)
library(mSTEM)

theme_set(theme_bw())
theme_update(
  legend.title = element_blank(),
  panel.grid.minor = element_blank()
)
```



## Read in files. Get TE patients and AKI patients. 
```{r warning=FALSE, message=FALSE}

#Read in local patient summary: Change data_dir to the folder where your data files are located

data_dir <- "../4ce/Input/"
data_dir <- "/users/emily/Downloads"
demo_raw <-
  readr::read_csv(
    file.path(data_dir, "LocalPatientSummary.csv"),
    col_types = list(patient_num = readr::col_character()),
    na = "1900-01-01"
  ) %>%
  mutate(across(ends_with("_date") & where(is.character), lubridate::mdy)) %>%
  mutate(
    last_discharge_date = if_else(
      !is.na(death_date) & death_date < last_discharge_date,
      death_date,
      last_discharge_date
    )
  )

#Read in thrombotic icd codes. Add column "truncated code" for first three characters of each code. Extract unique truncated codes. 

thrombo_codes <- read_csv("https://raw.githubusercontent.com/covidclinical/Phase2.1AKIRPackage/ac19716a4586f45c398728fcd821ca9d5baffe45/FourCePhase2.1AKI/data-raw/thromb_icd_code.csv") %>%
  mutate(truncated_code = substr(icd_code, 1, 3)) %>%
  pull(truncated_code) %>%
  unique()

#Extract information for patients with codes for thrombotic events

patient_obs <- read_csv(
  file.path(data_dir, "LocalPatientObservations.csv"),
  col_types = list(patient_num = readr::col_character()),
  na = "-999"
)

te_patients <- patient_obs %>%
  filter(
    concept_type == "DIAG-ICD10",
    concept_code %in% thrombo_codes,
    days_since_admission >= 0
  )
```


```{R message=FALSE}
# 4CE long format Labs Data


# Code, Descriptions and Ranges
lab_mapping <- read_csv("public-data/loinc-map.csv")
lab_bounds <- read_csv("public-data/lab_bounds.csv")
lab_names <- lab_bounds$short_name

# load('public-data/code.dict.rda')
```

```{R message=FALSE}

#Get AKI patients

#Code from AKI Group (https://github.com/covidclinical/Phase2.1AKIRPackage)

observations = patient_obs
demographics = demo_raw

demographics <- demographics %>% dplyr::mutate(patient_id=paste("Penn",patient_num,sep="_"))


    demographics_filt <- demographics %>% dplyr::mutate(time_to_severe = ifelse(severe == 1, as.numeric(as.Date(severe_date) - as.Date(admission_date)),NA))
    demographics_filt <- demographics_filt %>% dplyr::mutate(time_to_death = ifelse(deceased == 1, as.numeric(as.Date(death_date) - as.Date(admission_date)),NA))
    demographics_filt <- demographics_filt %>% dplyr::mutate(length_stay = ifelse(still_in_hospital==1,days_since_admission,as.numeric(as.Date(last_discharge_date) - as.Date(admission_date))))
    
    # Reorder the columns to be more readable
    demographics_filt <- demographics_filt %>% dplyr::select(patient_num,siteid,sex,age_group,race,length_stay,severe,time_to_severe,deceased,time_to_death)
    


diagnosis <- observations[observations$concept_type %in% c("DIAG-ICD9","DIAG-ICD10"),-6]
    colnames(diagnosis) <- c("patient_num","siteid","days_since_admission","concept_type","icd_code")
    

procedures <- observations[observations$concept_type %in% c("PROC-ICD9", "PROC-ICD10"),-6]
colnames(procedures) <- c("patient_num","siteid","days_since_admission","icd_version","procedure_code")
    
# Extract serum Cr levels
    labs_cr_aki <- observations[observations$concept_code == '2160-0',] #LOINC code for Cr 2160-0
    # Remove unnecessary columns
    labs_cr_aki <- labs_cr_aki[,-c(4,5)]
    # Filter for labs >= -90 days
    labs_cr_aki <- labs_cr_aki %>% dplyr::filter(days_since_admission >= -90)
    
    # Generate separate demographics table for patients who do not have any sCr values fulfilling 
    # the above (e.g. all the labs are before t= -90days or patient has no sCr value)
    message("Removing patients who do not have any serum creatinine values during admission...")
    pts_valid_cr <- labs_cr_aki %>% dplyr::filter(days_since_admission >= 0)
    pts_valid_cr <- unique(pts_valid_cr$patient_num)
    demog_no_cr <- demographics_filt[!(demographics_filt$patient_num %in% pts_valid_cr),]
    demographics_filt <- demographics_filt[demographics_filt$patient_num %in% pts_valid_cr,]
    labs_cr_aki <- labs_cr_aki[labs_cr_aki$patient_num %in% pts_valid_cr,]
    # There are two possible scenarios which we have to consider when detecting each AKI event:
    # (1) AKI occurs after admission
    #   - easy to detect with the formal KDIGO definition as we only need to use older data points
    #   - we can use an approach similar to what is used in the MIMIC-III data-set: use a rolling
    #     time frame and detect the lowest Cr value to use as our baseline
    # (2) Patient presents with an AKI at the time of admission 
    #   - this makes it harder for us to determine what is the true baseline especially with limited
    #     longitudinal data
    #   - Hence one way to get around this is to generate a "retrospective" baseline (i.e. look into
    #     future Cr values and find the minimum in a rolling timeframe) and use this as a surrogate
    #     baseline
    #   - Such a workaround is the only feasible way of dealing with missing retrospective data though
    #     it is likely that we may miss quite a number of true AKIs using this method
    
    # Scenario (1): AKI occurs during admission
    # Find minimum Cr level in a rolling 90 day timeframe
    message("Generating minimum Cr level in the past 90 days")
    labs_cr_aki <- data.table::data.table(labs_cr_aki,key=c("patient_num","days_since_admission"))
    labs_cr_aki <- labs_cr_aki[data.table::CJ(unique(patient_num),seq(min(days_since_admission)-90,max(days_since_admission)))] # temporarily fill in null rows for missing days - the minimum rolling code only works for consecutive data
    labs_cr_aki <- labs_cr_aki %>% dplyr::group_by(patient_num) %>% dplyr::mutate(min_cr_90d = RcppRoll::roll_min(value,91,fill=NA,na.rm=TRUE,align="right")) %>% dplyr::filter(!is.na(value))
    # Find minimum Cr level in a rolling 2 day timeframe (48h)
    message("Generating minimum Cr level in the past 48h")
    labs_cr_aki <- data.table::data.table(labs_cr_aki,key=c("patient_num","days_since_admission"))
    labs_cr_aki <- labs_cr_aki[data.table::CJ(unique(patient_num),seq(min(days_since_admission)-2,max(days_since_admission)))] # temporarily fill in null rows for missing days - the minimum rolling code only works for consecutive data
    labs_cr_aki <- labs_cr_aki %>% dplyr::group_by(patient_num) %>% dplyr::mutate(min_cr_48h = RcppRoll::roll_min(value,3,fill=NA,na.rm=TRUE,align="right")) %>% dplyr::filter(!is.na(value))
    
    # Scenario (2): Patient presents with an AKI already on board
    # Find minimum Cr level in a rolling 7 day timeframe
    message("Generating minimum Cr level 7 days in the future")
    labs_cr_aki <- data.table::data.table(labs_cr_aki,key=c("patient_num","days_since_admission"))
    labs_cr_aki <- labs_cr_aki[data.table::CJ(unique(patient_num),seq(min(days_since_admission),max(days_since_admission)+7))] # temporarily fill in null rows for missing days - the minimum rolling code only works for consecutive data
    labs_cr_aki <- labs_cr_aki %>% dplyr::group_by(patient_num) %>% dplyr::mutate(min_cr_retro_7day = RcppRoll::roll_min(value,8,fill=NA,na.rm=TRUE,align="left")) %>% dplyr::filter(!is.na(value))
    # Find minimum Cr level in a rolling 2 day timeframe (48h)
    message("Generating minimum Cr level 48h in the future")
    labs_cr_aki <- data.table::data.table(labs_cr_aki,key=c("patient_num","days_since_admission"))
    labs_cr_aki <- labs_cr_aki[data.table::CJ(unique(patient_num),seq(min(days_since_admission),max(days_since_admission)+2))] # temporarily fill in null rows for missing days - the minimum rolling code only works for consecutive data
    labs_cr_aki <- labs_cr_aki %>% dplyr::group_by(patient_num) %>% dplyr::mutate(min_cr_48h_retro = RcppRoll::roll_min(value,3,fill=NA,na.rm=TRUE,align="left")) %>% dplyr::filter(!is.na(value))
    
  
labs_cr_aki <- data.table::setDT(labs_cr_aki)[,':='(cr_7d = tail(labs_cr_aki$value[labs_cr_aki$patient_num==patient_num][data.table::between(labs_cr_aki$days_since_admission[labs_cr_aki$patient_num==patient_num],days_since_admission,days_since_admission+7,incbounds = TRUE)],1),cr_90d = tail(labs_cr_aki$value[labs_cr_aki$patient_num==patient_num][data.table::between(labs_cr_aki$days_since_admission[labs_cr_aki$patient_num==patient_num],days_since_admission,days_since_admission+90,incbounds = TRUE)],1)),by=c('patient_num','days_since_admission')][]
    
    # At this point, our table has these headers:
    # patient_id  siteid  days_since_admission  value min_cr_90d min_cr_48h  min_cr_retro_7day min_cr_48h_retro  cr_7d cr_90d
    
    # Now we have to start grading AKI severity at each time point
    # This approach is similar to how the MIMIC-III dataset generates AKI severity
    # Generate two columns using both the formal KDIGO AKI definition and the modified retrospective AKI definition
    message("Generating KDIGO severity grades for each serum Cr value")
    labs_cr_aki$aki_kdigo <- apply(labs_cr_aki,1,FourCePhase2.1AKI:::aki_kdigo_grade)
    labs_cr_aki$aki_kdigo_retro <- apply(labs_cr_aki,1,FourCePhase2.1AKI:::aki_kdigo_grade_retro)
    labs_cr_aki <- labs_cr_aki %>% dplyr::group_by(patient_num,days_since_admission) %>% dplyr::mutate(aki_kdigo_final = max(aki_kdigo,aki_kdigo_retro))
    
    # Generate two columns grading AKD severity at 7d and 90d (grade 0B/C is coded as 0.5)
    labs_cr_aki$akd_7d <- apply(labs_cr_aki,1,FourCePhase2.1AKI:::akd_grade_7d)
    labs_cr_aki$akd_90d <- apply(labs_cr_aki,1,FourCePhase2.1AKI:::akd_grade_90d)
    
    # Now we are going to generate the start days of each AKI
    labs_cr_aki_tmp <- labs_cr_aki
    labs_cr_aki_tmp$valid = 1
    
    # Find the day of the minimum Cr used for grading AKIs (taken as baseline)
    message("Now finding the day at which the minimum serum Cr is achieved")
    labs_cr_aki_tmp <- labs_cr_aki_tmp %>% dplyr::group_by(patient_num) %>% tidyr::complete(days_since_admission = tidyr::full_seq(days_since_admission,1)) %>% dplyr::mutate(value = zoo::na.fill(value,Inf))
    labs_cr_aki_tmp2 <- labs_cr_aki_tmp
    labs_cr_aki_tmp3 <- labs_cr_aki_tmp
    labs_cr_aki_tmp2 <- labs_cr_aki_tmp2 %>% split(.$patient_num) %>% purrr::map_df(~dplyr::data_frame(.x),.id='patient_num')
    colnames(labs_cr_aki_tmp2)[2] <- "day_min"
    labs_cr_aki_tmp3 <- labs_cr_aki_tmp3 %>% split(.$patient_num) %>%  purrr::map_df(~dplyr::data_frame(.x),.id='patient_num')
    colnames(labs_cr_aki_tmp3)[2] <- "day_min_retro"
    labs_cr_aki_tmp4 <- cbind(labs_cr_aki_tmp,"day_min" = labs_cr_aki_tmp2$day_min,"day_min_retro" = labs_cr_aki_tmp3$day_min_retro)
    labs_cr_aki_tmp4 <- labs_cr_aki_tmp4[!is.na(labs_cr_aki_tmp4$valid),]
    
    # Generate delta_cr
    message("Now identifying maxima points of serum Cr")
    labs_cr_aki_tmp4 <- labs_cr_aki_tmp4 %>% dplyr::group_by(patient_num,days_since_admission) %>% dplyr::mutate(min_cr_7d_final = min(min_cr_90d,min_cr_retro_7day,na.rm=TRUE)) %>% dplyr::mutate(delta_cr = value - min_cr_7d_final)
    
    # Use the largest delta_cr to find the peak of each AKI
    labs_cr_aki_delta_maxima <- labs_cr_aki_tmp4 %>% dplyr::group_by(patient_num) %>% dplyr::filter(delta_cr %in% delta_cr[which.peaks(delta_cr,decreasing=FALSE)])
    labs_cr_aki_delta_maxima$delta_is_max = 1
    labs_cr_aki_delta_maxima <- labs_cr_aki_delta_maxima %>% dplyr::rename(delta_maxima = delta_cr) %>% dplyr::select(patient_num,days_since_admission,delta_maxima,delta_is_max)
    labs_cr_aki_tmp4 <- merge(labs_cr_aki_tmp4,labs_cr_aki_delta_maxima,by=c("patient_num","days_since_admission"),all.x=TRUE)
    
    # Filter for KDIGO grades > 0
    message("Now generating tables of all AKI events")
    labs_cr_aki_tmp5 <- labs_cr_aki_tmp4[labs_cr_aki_tmp4$aki_kdigo_final > 0,]
    labs_cr_aki_tmp5[is.na(labs_cr_aki_tmp5)] <- 0
    # Filter for maxima of delta_cr (which should give us the peaks)
    labs_cr_aki_tmp5 <- labs_cr_aki_tmp5[labs_cr_aki_tmp5$delta_is_max > 0,]
    
    # Filter and reorder columns to generate our final table of all AKI events
    labs_aki_summ <- labs_cr_aki_tmp5 %>% dplyr::select(patient_num,siteid,days_since_admission,value,day_min,day_min_retro,min_cr_90d,min_cr_48h,min_cr_retro_7day,min_cr_48h_retro,min_cr_7d_final,cr_7d,cr_90d,delta_cr,aki_kdigo,aki_kdigo_retro,aki_kdigo_final,akd_7d,akd_90d)
    
    labs_aki_summ <- labs_aki_summ %>% dplyr::distinct(patient_num,days_since_admission,.keep_all=TRUE)
    labs_aki_summ <- labs_aki_summ %>% dplyr::filter(days_since_admission >= 0)
    
    
AKI_patients <- patient_obs[patient_obs$patient_num %in% as.integer(unique(labs_aki_summ$patient_num)),]

       
```   



```{R}
# setdiff(patient_obs$concept_code %>% unique(), lab_bounds$LOINC)

#Generate a table that contains information about each lab for each individual patient. Clean up data by removing observations with missing lab names or < 0 days since admission. Each observation is identified by their patient number and days since admission, and each lab name and value is included. If there is more than one lab value for that identifier, they are averaged. Also add severity column. 

patient_obs_wide <- patient_obs %>%
  left_join(lab_bounds, by = c("concept_code" = "LOINC")) %>%
  filter(days_since_admission >= 0, !is.na(short_name)) %>%
  select(-concept_code) %>%
  pivot_wider(
    id_cols = c(patient_num, days_since_admission),
    names_from = short_name,
    values_from = value,
    values_fn = mean
  ) %>%
  left_join(select(demo_raw, patient_num, severe), by = "patient_num") %>%
  mutate(severity = factor(severe) %>%
    fct_recode("severe" = "1", "nonsevere" = "0")) %>%
  select(-severe)

#Extract unique lab names

lab_names <- intersect(lab_bounds$short_name, names(patient_obs_wide))



Severe_patients <- patient_obs_wide[patient_obs_wide$severity == "severe",]
```


```{R}


avgs = patient_obs_wide[FALSE,] %>% select(-c(patient_num,days_since_admission,severity))

props = patient_obs_wide[FALSE,] %>% select(-c(patient_num,days_since_admission,severity))
ct = 1
for (i in 1:length(unique(patient_obs_wide$patient_num))) {
  for (j in 1:ncol(avgs)) {
    dat <- filter(patient_obs_wide,patient_num==i)
    if (nrow(dat) != 0){
      num_miss = sum(is.na(dat[j+2]))
      avgs[ct,j] = num_miss
      props[ct,j] = num_miss/(nrow(dat[j+2]))
      if ( j == ncol(avgs)){
        ct = ct + 1
      }
    }
  }
}

dat_prop = colMeans(props)
dat_sd_prop = apply(props,2,sd)
dat_num = colMeans(avgs)
dat_sd_num = apply(avgs,2,sd)
site = rep("Penn",length(dat_prop))
df_prop = data.frame(Labs = colnames(avgs), Avg_Prop_Miss = dat_prop,sd = dat_sd_prop,Site=site)
df_num = data.frame(Labs = colnames(avgs), Avg_Num_Miss = dat_num,sd = dat_sd_num,Site=site)

df_prop$Labs <- factor(df_prop$Labs,levels = c("Fibrinogen","Troponin_normal","Procalcitonin","FEU","Troponin_high","CRP","Ferritin","LDH","Lymphocyte","PT","Albumin","Neutrophil","AST","ALT","Bilirubin","Leukocytes","Creatinine"))
df_num$Labs <- factor(df_prop$Labs,levels = c("Fibrinogen","Troponin_normal","Procalcitonin","FEU","Troponin_high","CRP","Ferritin","LDH","Lymphocyte","PT","Albumin","Neutrophil","AST","ALT","Bilirubin","Leukocytes","Creatinine"))


prop_plot = ggplot(data = df_prop,
       aes(x = Labs,
           y = Avg_Prop_Miss,
           fill = Site)) +
         geom_bar(stat = "identity") + 
          labs(x = "Labs",y = "Mean +/- Sd Proportion Missing Per Patient",fill="Site") +
  theme(axis.text.x=element_text(angle=90,vjust = 0.5, hjust=1)) +
        geom_errorbar(aes(ymin=pmax(Avg_Prop_Miss-sd,0),ymax = pmin(Avg_Prop_Miss + sd,1)), width = .2,position=position_dodge(.9)) 

prop_plot 

num_plot = ggplot(data = df_num,
       aes(x = Labs,
           y = Avg_Num_Miss,
           fill = Site)) +
         geom_bar(stat = "identity") + 
          labs(x = "Labs",y = "Average Number Missing Per Patient",fill="Site") +
  theme(axis.text.x=element_text(angle=90,vjust = 0.5, hjust=1)) +
    geom_errorbar(aes(ymin=pmax(Avg_Num_Miss-sd,0),ymax = Avg_Num_Miss + sd), width = .2,position=position_dodge(.9)) 

num_plot

df_prop_penn = df_prop
df_num_penn = df_num

require(gridExtra)
grid.arrange(prop_plot,num_plot,ncol=1)






```
```{R}

#Stratify by sex!

props_M = patient_obs_wide[FALSE,] %>% select(-c(patient_num,days_since_admission,severity))
props_F = patient_obs_wide[FALSE,] %>% select(-c(patient_num,days_since_admission,severity))

indices_M = which(demo_raw$sex=="male")
indices_F = which(demo_raw$sex=="female")

ct = 1
for (i in 1:length(as.integer(unique(patient_obs_wide$patient_num)))) {
  if (as.integer(unique(patient_obs_wide$patient_num))[i] %in% indices_M){
  
  for (j in 1:ncol(props_M)) {
    dat <- filter(patient_obs_wide,patient_num==i)
    if (nrow(dat) != 0){
      num_miss = sum(is.na(dat[j+2]))
      props_M[ct,j] = num_miss/(nrow(dat[j+2]))
      if ( j == ncol(props_M)){
        ct = ct + 1
      }
    }
  }
  }
}


ct = 1
for (i in 1:length(as.integer(unique(patient_obs_wide$patient_num)))) {
  if (as.integer(unique(patient_obs_wide$patient_num))[i] %in% indices_F){
  for (j in 1:ncol(props_F)) {
    dat <- filter(patient_obs_wide,patient_num==i)
    if (nrow(dat) != 0){
      num_miss = sum(is.na(dat[j+2]))
      props_F[ct,j] = num_miss/(nrow(dat[j+2]))
      if ( j == ncol(props_F)){
        ct = ct + 1
      }
    }
  }
  }
}



dat_prop_M = colMeans(props_M)
dat_prop_F = colMeans(props_F)
dat_sd_M= apply(props_M,2,sd)
dat_sd_F= apply(props_F,2,sd)
diff = dat_prop_M-dat_prop_F

sex_M = rep("Male",length(dat_prop_M))
sex_F = rep("Female",length(dat_prop_F))
df_prop_M = data.frame(Labs = colnames(props_M), Avg_Prop_Miss = dat_prop_M,sd = dat_sd_M,Sex=sex_M)
df_prop_M$Labs <- factor(df_prop_M$Labs,levels = c("Fibrinogen","Troponin_normal","Procalcitonin","FEU","Troponin_high","CRP","Ferritin","LDH","Lymphocyte","PT","Albumin","Neutrophil","AST","ALT","Bilirubin","Leukocytes","Creatinine"))
df_prop_F = data.frame(Labs = colnames(props_F), Avg_Prop_Miss = dat_prop_F,sd = dat_sd_F,Sex=sex_F)
df_prop_F$Labs <- factor(df_prop_F$Labs,levels = c("Fibrinogen","Troponin_normal","Procalcitonin","FEU","Troponin_high","CRP","Ferritin","LDH","Lymphocyte","PT","Albumin","Neutrophil","AST","ALT","Bilirubin","Leukocytes","Creatinine"))
df_prop_diff_sex = data.frame(Labs = colnames(props_F), Avg_Prop_Miss = diff)
df_prop_diff_sex$Labs <- factor(df_prop_diff_sex$Labs,levels = c("Fibrinogen","Troponin_normal","Procalcitonin","FEU","Troponin_high","CRP","Ferritin","LDH","Lymphocyte","PT","Albumin","Neutrophil","AST","ALT","Bilirubin","Leukocytes","Creatinine"))



df_prop_Sex = rbind(df_prop_M,df_prop_F)
site = rep("Penn",nrow(df_prop_Sex))
df_prop_Sex$Site = site

prop_plot_Sex = ggplot(data = df_prop_Sex,
       aes(x = Labs,
           y = Avg_Prop_Miss,
           fill = Sex)) +
         geom_bar(stat = "identity",width=0.8,position=position_dodge()) + 
          labs(title = "Stratified by Sex", x = "Labs",y = "Mean +/- Sd Proportion Missing Per Patient",fill="Sex")+
  theme(axis.text.x=element_text(angle=90,vjust = 0.5, hjust=1)) +
    geom_errorbar(aes(ymin=pmax(Avg_Prop_Miss-sd,0),ymax = Avg_Prop_Miss + sd), width = .1,position=position_dodge(.9)) 

prop_plot_Sex

df_prop_diff_sex_penn = df_prop_diff_sex
Site = rep("Penn",nrow(df_prop_diff_sex_penn))
df_prop_diff_sex_penn$site = Site


prop_plot_diff_sex_penn = ggplot(data = df_prop_diff_sex_penn,
       aes(x = reorder(Labs,Avg_Prop_Miss),
           y = Avg_Prop_Miss,
           fill = site)) +
         geom_bar(stat = "identity") + 
          labs(title = "Stratified by Sex",x = "Labs",y = "Mean Difference in Proportion Missing Per Patient",fill="Site") +
  theme(axis.text.x=element_text(angle=90,vjust = 0.5, hjust=1)) 

prop_plot_diff_sex_penn


#Stratify by severity!


props_S = patient_obs_wide[FALSE,] %>% select(-c(patient_num,days_since_admission,severity))
props_NS = patient_obs_wide[FALSE,] %>% select(-c(patient_num,days_since_admission,severity))

indices_S = which(demo_raw$severe==1)
indices_NS = which(demo_raw$severe==0)

ct = 1
for (i in 1:length(as.integer(unique(patient_obs_wide$patient_num)))) {
  if (as.integer(unique(patient_obs_wide$patient_num))[i] %in% indices_S){
  
  for (j in 1:ncol(props_S)) {
    dat <- filter(patient_obs_wide,patient_num==i)
    if (nrow(dat) != 0){
      num_miss = sum(is.na(dat[j+2]))
      props_S[ct,j] = num_miss/(nrow(dat[j+2]))
      if ( j == ncol(props_S)){
        ct = ct + 1
      }
    }
  }
  }
}


ct = 1
for (i in 1:length(as.integer(unique(patient_obs_wide$patient_num)))) {
  if (as.integer(unique(patient_obs_wide$patient_num))[i] %in% indices_NS){
  for (j in 1:ncol(props_NS)) {
    dat <- filter(patient_obs_wide,patient_num==i)
    if (nrow(dat) != 0){
      num_miss = sum(is.na(dat[j+2]))
      props_NS[ct,j] = num_miss/(nrow(dat[j+2]))
      if ( j == ncol(props_NS)){
        ct = ct + 1
      }
    }
  }
  }
}


dat_prop_S = colMeans(props_S)
dat_prop_NS = colMeans(props_NS)
dat_sd_prop_S = apply(props_S,2,sd)
dat_sd_prop_NS = apply(props_NS,2,sd)
diff = dat_prop_S-dat_prop_NS

severe = rep("Severe",length(dat_prop_S))
non_severe = rep("Non-Severe",length(dat_prop_NS))
df_prop_S = data.frame(Labs = colnames(props_S), Avg_Prop_Miss = dat_prop_S,sd = dat_sd_prop_S,severity = severe)
df_prop_S$Labs <- factor(df_prop_S$Labs,levels = c("Fibrinogen","Troponin_normal","Procalcitonin","FEU","Troponin_high","CRP","Ferritin","LDH","Lymphocyte","PT","Albumin","Neutrophil","AST","ALT","Bilirubin","Leukocytes","Creatinine"))
df_prop_NS = data.frame(Labs = colnames(props_NS), Avg_Prop_Miss = dat_prop_NS,sd = dat_sd_prop_NS,severity = non_severe)
df_prop_NS$Labs <- factor(df_prop_NS$Labs,levels = c("Fibrinogen","Troponin_normal","Procalcitonin","FEU","Troponin_high","CRP","Ferritin","LDH","Lymphocyte","PT","Albumin","Neutrophil","AST","ALT","Bilirubin","Leukocytes","Creatinine"))
df_prop_diff_severity = data.frame(Labs = colnames(props_S), Avg_Prop_Miss = diff)
df_prop_diff_severity$Labs <- factor(df_prop_diff_severity$Labs,levels = c("Fibrinogen","Troponin_normal","Procalcitonin","FEU","Troponin_high","CRP","Ferritin","LDH","Lymphocyte","PT","Albumin","Neutrophil","AST","ALT","Bilirubin","Leukocytes","Creatinine"))


df_prop_Severity = rbind(df_prop_S,df_prop_NS)
site = rep("Penn",nrow(df_prop_Severity))
df_prop_Severity$Site = site

prop_plot_Severity = ggplot(data = df_prop_Severity,
       aes(x = Labs,
           y = Avg_Prop_Miss,
           fill = severity)) +
         geom_bar(stat = "identity",width=0.8,position=position_dodge()) + 
          labs(title = "Stratified by Severity",x = "Labs",y = "Mean +/- Sd Proportion Missing Per Patient",fill="Severity")+
  theme(axis.text.x=element_text(angle=90,vjust = 0.5, hjust=1)) +
    geom_errorbar(aes(ymin=pmax(Avg_Prop_Miss-sd,0),ymax = Avg_Prop_Miss + sd), width = .1,position=position_dodge(.9)) 

prop_plot_Severity

df_prop_Severity_penn = df_prop_Severity

df_prop_diff_Severity_penn = df_prop_diff_severity
Site = rep("Penn",nrow(df_prop_diff_Severity_penn))
df_prop_diff_Severity_penn$site = Site



prop_plot_diff_severity_penn = ggplot(data = df_prop_diff_Severity_penn,
       aes(x = reorder(Labs,Avg_Prop_Miss),
           y = Avg_Prop_Miss,
           fill = Site)) +
         geom_bar(stat = "identity") + 
          labs(title = "Stratified by Severity",x = "Labs",y = "Mean Difference in Proportion Missing Per Patient",fill="Site") +
  theme(axis.text.x=element_text(angle=90,vjust = 0.5, hjust=1)) 

prop_plot_diff_severity_penn



#Stratify by ethnicity!


props_W = patient_obs_wide[FALSE,] %>% select(-c(patient_num,days_since_admission,severity))
props_B = patient_obs_wide[FALSE,] %>% select(-c(patient_num,days_since_admission,severity))
props_A = patient_obs_wide[FALSE,] %>% select(-c(patient_num,days_since_admission,severity))
props_HL = patient_obs_wide[FALSE,] %>% select(-c(patient_num,days_since_admission,severity))
props_PI = patient_obs_wide[FALSE,] %>% select(-c(patient_num,days_since_admission,severity))
props_AI = patient_obs_wide[FALSE,] %>% select(-c(patient_num,days_since_admission,severity))
props_O = patient_obs_wide[FALSE,] %>% select(-c(patient_num,days_since_admission,severity))


indices_W = which(demo_raw$race=="white")
indices_B = which(demo_raw$race=="black")
indices_A = which(demo_raw$race=="asian")
indices_PI = which(demo_raw$race=="hawaiian_pacific_islander")
indices_HL = which(demo_raw$race=="hispanic_latino")
indices_AI = which(demo_raw$race=="american_indian" )
indices_O = which(demo_raw$race=="other")



ctw = 1
ctb = 1
cta = 1
cto = 1
ctpi = 1
cthl = 1
ctai = 1
for (i in 1:length(as.integer(unique(patient_obs_wide$patient_num)))) {
  if (as.integer(unique(patient_obs_wide$patient_num))[i] %in% indices_W){
  
  for (j in 1:ncol(props_W)) {
    dat <- filter(patient_obs_wide,patient_num==i)
    if (nrow(dat) != 0){
      num_miss = sum(is.na(dat[j+2]))
      props_W[ctw,j] = num_miss/(nrow(dat[j+2]))
      if ( j == ncol(props_W)){
        ctw = ctw + 1
      }
    }
  }
  }
  if (as.integer(unique(patient_obs_wide$patient_num))[i] %in% indices_B){
  
  for (j in 1:ncol(props_B)) {
    dat <- filter(patient_obs_wide,patient_num==i)
    if (nrow(dat) != 0){
      num_miss = sum(is.na(dat[j+2]))
      props_B[ctb,j] = num_miss/(nrow(dat[j+2]))
      if ( j == ncol(props_B)){
        ctb = ctb + 1
      }
    }
  }
  }
  if (as.integer(unique(patient_obs_wide$patient_num))[i] %in% indices_A){
  
  for (j in 1:ncol(props_A)) {
    dat <- filter(patient_obs_wide,patient_num==i)
    if (nrow(dat) != 0){
      num_miss = sum(is.na(dat[j+2]))
      props_A[cta,j] = num_miss/(nrow(dat[j+2]))
      if ( j == ncol(props_A)){
        cta = cta + 1
      }
    }
  }
  }
  if (as.integer(unique(patient_obs_wide$patient_num))[i] %in% indices_O){
  
  for (j in 1:ncol(props_O)) {
    dat <- filter(patient_obs_wide,patient_num==i)
    if (nrow(dat) != 0){
      num_miss = sum(is.na(dat[j+2]))
      props_O[cto,j] = num_miss/(nrow(dat[j+2]))
      if ( j == ncol(props_O)){
        cto = cto + 1
      }
    }
  }
  }
  if (as.integer(unique(patient_obs_wide$patient_num))[i] %in% indices_HL){
  
  for (j in 1:ncol(props_HL)) {
    dat <- filter(patient_obs_wide,patient_num==i)
    if (nrow(dat) != 0){
      num_miss = sum(is.na(dat[j+2]))
      props_HL[cthl,j] = num_miss/(nrow(dat[j+2]))
      if ( j == ncol(props_HL)){
        cthl = cthl + 1
      }
    }
  }
  }
  if (as.integer(unique(patient_obs_wide$patient_num))[i] %in% indices_PI){
  
  for (j in 1:ncol(props_PI)) {
    dat <- filter(patient_obs_wide,patient_num==i)
    if (nrow(dat) != 0){
      num_miss = sum(is.na(dat[j+2]))
      props_PI[ctpi,j] = num_miss/(nrow(dat[j+2]))
      if ( j == ncol(props_PI)){
        ctpi = ctpi + 1
      }
    }
  }
  }
  if (as.integer(unique(patient_obs_wide$patient_num))[i] %in% indices_AI){
  
  for (j in 1:ncol(props_AI)) {
    dat <- filter(patient_obs_wide,patient_num==i)
    if (nrow(dat) != 0){
      num_miss = sum(is.na(dat[j+2]))
      props_AI[ctai,j] = num_miss/(nrow(dat[j+2]))
      if ( j == ncol(props_AI)){
        ctai = ctai + 1
      }
    }
  }
  }
}


dat_prop_W = colMeans(props_W)
dat_prop_B= colMeans(props_B)
dat_prop_A = colMeans(props_A)
dat_prop_O= colMeans(props_O)
dat_prop_HL = colMeans(props_HL)
dat_prop_PI= colMeans(props_PI)
dat_prop_AI = colMeans(props_AI)

dat_sd_prop_W = apply(props_W,2,sd)
dat_sd_prop_B = apply(props_B,2,sd)
dat_sd_prop_A= apply(props_A,2,sd)
dat_sd_prop_O = apply(props_O,2,sd)
dat_sd_prop_HL = apply(props_HL,2,sd)
dat_sd_prop_PI = apply(props_PI,2,sd)
dat_sd_prop_AI = apply(props_AI,2,sd)


white = rep("white",length(dat_prop_W))
black = rep("black",length(dat_prop_B))
asian = rep("asian",length(dat_prop_A))
hisp_latino = rep("hispanic latino",length(dat_prop_HL))
pacific_islander = rep("hawaiian pacific islander",length(dat_prop_PI))
american_indian = rep("american indian",length(dat_prop_AI))
other = rep("other",length(dat_prop_O))

df_prop_W = data.frame(Labs = colnames(props_W), Avg_Prop_Miss = dat_prop_W,sd = dat_sd_prop_W,race=white)
df_prop_W$Labs <- factor(df_prop_W$Labs,levels = c("Fibrinogen","Troponin_normal","Procalcitonin","FEU","Troponin_high","CRP","Ferritin","LDH","Lymphocyte","PT","Albumin","Neutrophil","AST","ALT","Bilirubin","Leukocytes","Creatinine"))

df_prop_B = data.frame(Labs = colnames(props_B), Avg_Prop_Miss = dat_prop_B,sd = dat_sd_prop_B,race=black)
df_prop_B$Labs <- factor(df_prop_B$Labs,levels = c("Fibrinogen","Troponin_normal","Procalcitonin","FEU","Troponin_high","CRP","Ferritin","LDH","Lymphocyte","PT","Albumin","Neutrophil","AST","ALT","Bilirubin","Leukocytes","Creatinine"))

df_prop_A = data.frame(Labs = colnames(props_A), Avg_Prop_Miss = dat_prop_A,sd = dat_sd_prop_A,race=asian)
df_prop_A$Labs <- factor(df_prop_A$Labs,levels = c("Fibrinogen","Troponin_normal","Procalcitonin","FEU","Troponin_high","CRP","Ferritin","LDH","Lymphocyte","PT","Albumin","Neutrophil","AST","ALT","Bilirubin","Leukocytes","Creatinine"))

df_prop_PI = data.frame(Labs = colnames(props_PI), Avg_Prop_Miss = dat_prop_PI,sd = dat_sd_prop_PI,race=pacific_islander)
df_prop_PI$Labs <- factor(df_prop_PI$Labs,levels = c("Fibrinogen","Troponin_normal","Procalcitonin","FEU","Troponin_high","CRP","Ferritin","LDH","Lymphocyte","PT","Albumin","Neutrophil","AST","ALT","Bilirubin","Leukocytes","Creatinine"))

df_prop_O = data.frame(Labs = colnames(props_O), Avg_Prop_Miss = dat_prop_O,sd = dat_sd_prop_O,race=other)
df_prop_O$Labs <- factor(df_prop_O$Labs,levels = c("Fibrinogen","Troponin_normal","Procalcitonin","FEU","Troponin_high","CRP","Ferritin","LDH","Lymphocyte","PT","Albumin","Neutrophil","AST","ALT","Bilirubin","Leukocytes","Creatinine"))

df_prop_HL = data.frame(Labs = colnames(props_HL), Avg_Prop_Miss = dat_prop_HL,sd = dat_sd_prop_HL,race=hisp_latino)
df_prop_O$Labs <- factor(df_prop_O$Labs,levels = c("Fibrinogen","Troponin_normal","Procalcitonin","FEU","Troponin_high","CRP","Ferritin","LDH","Lymphocyte","PT","Albumin","Neutrophil","AST","ALT","Bilirubin","Leukocytes","Creatinine"))

df_prop_AI = data.frame(Labs = colnames(props_AI), Avg_Prop_Miss = dat_prop_AI,sd = dat_sd_prop_AI,race=american_indian)
df_prop_AI$Labs <- factor(df_prop_AI$Labs,levels = c("Fibrinogen","Troponin_normal","Procalcitonin","FEU","Troponin_high","CRP","Ferritin","LDH","Lymphocyte","PT","Albumin","Neutrophil","AST","ALT","Bilirubin","Leukocytes","Creatinine"))

df_prop_Race = rbind(df_prop_W, df_prop_B, df_prop_A,df_prop_HL, df_prop_PI, df_prop_AI, df_prop_O)

site = rep("Penn",nrow(df_prop_Race))
df_prop_Race$Site = site

df_prop_Race_penn = df_prop_Race

prop_plot_W = ggplot(data = df_prop_W,
       aes(x = Labs,
           y = Avg_Prop_Miss)) +
         geom_bar(stat = "identity") + 
          labs(title = "White",y = "Mean +/- Sd Proportion Missing Per Patient") +
  geom_errorbar(aes(ymin=pmax(Avg_Prop_Miss-sd,0),ymax = Avg_Prop_Miss + sd), width = .2,position=position_dodge(.9)) +
        coord_flip() 

prop_plot_B = ggplot(data = df_prop_B,
       aes(x = Labs,
           y = Avg_Prop_Miss)) +
         geom_bar(stat = "identity") + 
          labs(title = "Black",y = "Mean +/- Sd Proportion Missing Per Patient") +
  geom_errorbar(aes(ymin=pmax(Avg_Prop_Miss-sd,0),ymax = Avg_Prop_Miss + sd), width = .2,position=position_dodge(.9)) +
        coord_flip() 

prop_plot_A = ggplot(data = df_prop_A,
       aes(x = Labs,
           y = Avg_Prop_Miss)) +
         geom_bar(stat = "identity") + 
          labs(title = "Asian",x = "Labs",y = "Mean +/- Sd Proportion Missing Per Patient",fill="Site") +
  geom_errorbar(aes(ymin=pmax(Avg_Prop_Miss-sd,0),ymax = Avg_Prop_Miss + sd), width = .2,position=position_dodge(.9)) +
        coord_flip() 

prop_plot_O = ggplot(data = df_prop_O,
       aes(x = Labs,
           y = Avg_Prop_Miss)) +
         geom_bar(stat = "identity") + 
          labs(title = "Other",x = "Labs",y = "Mean +/- Sd Proportion Missing Per Patient",fill="Site") +
  geom_errorbar(aes(ymin=pmax(Avg_Prop_Miss-sd,0),ymax = Avg_Prop_Miss + sd), width = .2,position=position_dodge(.9)) +
        coord_flip() 

prop_plot_HL = ggplot(data = df_prop_HL,
       aes(x = Labs,
           y = Avg_Prop_Miss)) +
         geom_bar(stat = "identity") + 
          labs(title = "Hispanic Latino",x = "Labs",y = "Mean +/- Sd Proportion Missing Per Patient",fill="Site") +
  geom_errorbar(aes(ymin=pmax(Avg_Prop_Miss-sd,0),ymax = Avg_Prop_Miss + sd), width = .2,position=position_dodge(.9)) +
        coord_flip() 

prop_plot_PI = ggplot(data = df_prop_PI,
       aes(x = Labs,
           y = Avg_Prop_Miss)) +
         geom_bar(stat = "identity") + 
          labs(title = "Hawaiian / Pacific Islander",x = "Labs",y = "Mean +/- Sd Proportion Missing Per Patient",fill="Site") +
  geom_errorbar(aes(ymin=pmax(Avg_Prop_Miss-sd,0),ymax = Avg_Prop_Miss + sd), width = .2,position=position_dodge(.9)) +
        coord_flip() 

prop_plot_AI = ggplot(data = df_prop_AI,
       aes(x = Labs,
           y = Avg_Prop_Miss)) +
         geom_bar(stat = "identity") + 
          labs(title = "American Indian ",x = "Labs",y = "Mean +/- Sd Proportion Missing Per Patient",fill="Site") +
  geom_errorbar(aes(ymin=pmax(Avg_Prop_Miss-sd,0),ymax = Avg_Prop_Miss + sd), width = .2,position=position_dodge(.9)) +
        coord_flip() 



require(gridExtra)
grid.arrange(prop_plot_W,prop_plot_PI,prop_plot_AI,prop_plot_O,ncol=2)






#Stratify by age!


props_1225 = patient_obs_wide[FALSE,] %>% select(-c(patient_num,days_since_admission,severity))
props_2649 = patient_obs_wide[FALSE,] %>% select(-c(patient_num,days_since_admission,severity))
props_5069 = patient_obs_wide[FALSE,] %>% select(-c(patient_num,days_since_admission,severity))
props_70plus = patient_obs_wide[FALSE,] %>% select(-c(patient_num,days_since_admission,severity))


indices_1225 = which(demo_raw$age_group=="12to17" | demo_raw$age_group=="18to25")
indices_2649 = which(demo_raw$age_group=="26to49")
indices_5069 = which(demo_raw$age_group=="50to69")
indices_70plus = which(demo_raw$age_group=="70to79" | demo_raw$age_group=="80plus")




cty = 1
ctm = 1
cto = 1
ctoo = 1

for (i in 1:length(as.integer(unique(patient_obs_wide$patient_num)))) {
  if (as.integer(unique(patient_obs_wide$patient_num))[i] %in% indices_1225){
  
  for (j in 1:ncol(props_1225)) {
    dat <- filter(patient_obs_wide,patient_num==i)
    if (nrow(dat) != 0){
      num_miss = sum(is.na(dat[j+2]))
      props_1225[cty,j] = num_miss/(nrow(dat[j+2]))
      if ( j == ncol(props_1225)){
        cty = cty + 1
      }
    }
  }
  }
  if (as.integer(unique(patient_obs_wide$patient_num))[i] %in% indices_2649){
  
  for (j in 1:ncol(props_2649)) {
    dat <- filter(patient_obs_wide,patient_num==i)
    if (nrow(dat) != 0){
      num_miss = sum(is.na(dat[j+2]))
      props_2649[ctm,j] = num_miss/(nrow(dat[j+2]))
      if ( j == ncol(props_2649)){
        ctm = ctm + 1
      }
    }
  }
  }
  if (as.integer(unique(patient_obs_wide$patient_num))[i] %in% indices_5069){
  
  for (j in 1:ncol(props_5069)) {
    dat <- filter(patient_obs_wide,patient_num==i)
    if (nrow(dat) != 0){
      num_miss = sum(is.na(dat[j+2]))
      props_5069[cto,j] = num_miss/(nrow(dat[j+2]))
      if ( j == ncol(props_5069)){
        cto = cto + 1
      }
    }
  }
  }
  if (as.integer(unique(patient_obs_wide$patient_num))[i] %in% indices_70plus){
  
  for (j in 1:ncol(props_70plus)) {
    dat <- filter(patient_obs_wide,patient_num==i)
    if (nrow(dat) != 0){
      num_miss = sum(is.na(dat[j+2]))
      props_70plus[ctoo,j] = num_miss/(nrow(dat[j+2]))
      if ( j == ncol(props_70plus)){
        ctoo = ctoo + 1
      }
    }
  }
  }
}


dat_prop_y = colMeans(props_1225)
dat_prop_m= colMeans(props_2649)
dat_prop_o = colMeans(props_5069)
dat_prop_oo= colMeans(props_70plus)


dat_sd_prop_y = apply(props_1225,2,sd)
dat_sd_prop_m = apply(props_2649,2,sd)
dat_sd_prop_o= apply(props_5069,2,sd)
dat_sd_prop_oo = apply(props_70plus,2,sd)


young = rep("Young",length(dat_prop_y))
middle = rep("Middle",length(dat_prop_m))
old = rep("Old",length(dat_prop_o))
older = rep("Older",length(dat_prop_oo))


df_prop_y = data.frame(Labs = colnames(props_1225), Avg_Prop_Miss = dat_prop_y,sd = dat_sd_prop_y,Age=young)
df_prop_y$Labs <- factor(df_prop_y$Labs,levels = c("Fibrinogen","Troponin_normal","Procalcitonin","FEU","Troponin_high","CRP","Ferritin","LDH","Lymphocyte","PT","Albumin","Neutrophil","AST","ALT","Bilirubin","Leukocytes","Creatinine"))

df_prop_m = data.frame(Labs = colnames(props_2649), Avg_Prop_Miss = dat_prop_m,sd = dat_sd_prop_m,Age=middle)
df_prop_m$Labs <- factor(df_prop_m$Labs,levels = c("Fibrinogen","Troponin_normal","Procalcitonin","FEU","Troponin_high","CRP","Ferritin","LDH","Lymphocyte","PT","Albumin","Neutrophil","AST","ALT","Bilirubin","Leukocytes","Creatinine"))

df_prop_o = data.frame(Labs = colnames(props_5069), Avg_Prop_Miss = dat_prop_o,sd = dat_sd_prop_oo,Age=old)
df_prop_o$Labs <- factor(df_prop_o$Labs,levels = c("Fibrinogen","Troponin_normal","Procalcitonin","FEU","Troponin_high","CRP","Ferritin","LDH","Lymphocyte","PT","Albumin","Neutrophil","AST","ALT","Bilirubin","Leukocytes","Creatinine"))

df_prop_oo = data.frame(Labs = colnames(props_70plus), Avg_Prop_Miss = dat_prop_oo,sd = dat_sd_prop_oo,Age=older)
df_prop_oo$Labs <- factor(df_prop_oo$Labs,levels = c("Fibrinogen","Troponin_normal","Procalcitonin","FEU","Troponin_high","CRP","Ferritin","LDH","Lymphocyte","PT","Albumin","Neutrophil","AST","ALT","Bilirubin","Leukocytes","Creatinine"))

df_prop_Age = rbind(df_prop_y, df_prop_m,df_prop_o,df_prop_oo)

site = rep("Penn",nrow(df_prop_Age))
df_prop_Age$Site = site

df_prop_Age_penn = df_prop_Age

prop_plot_y = ggplot(data = df_prop_y,
       aes(x = Labs,
           y = Avg_Prop_Miss)) +
         geom_bar(stat = "identity") + 
          labs(title = "12-25",y = "Mean +/- Sd Proportion Missing Per Patient") +
  geom_errorbar(aes(ymin=pmax(Avg_Prop_Miss-sd,0),ymax = Avg_Prop_Miss + sd), width = .2,position=position_dodge(.9)) +
        coord_flip() 

prop_plot_m = ggplot(data = df_prop_m,
       aes(x = Labs,
           y = Avg_Prop_Miss)) +
         geom_bar(stat = "identity") + 
          labs(title = "26-49",y = "Mean +/- Sd Proportion Missing Per Patient") +
  geom_errorbar(aes(ymin=pmax(Avg_Prop_Miss-sd,0),ymax = Avg_Prop_Miss + sd), width = .2,position=position_dodge(.9)) +
        coord_flip() 

prop_plot_o = ggplot(data = df_prop_o,
       aes(x = Labs,
           y = Avg_Prop_Miss)) +
         geom_bar(stat = "identity") + 
          labs(title = "50-69",x = "Labs",y = "Mean +/- Sd Proportion Missing Per Patient",fill="Site") +
  geom_errorbar(aes(ymin=pmax(Avg_Prop_Miss-sd,0),ymax = Avg_Prop_Miss + sd), width = .2,position=position_dodge(.9)) +
        coord_flip() 

prop_plot_oo = ggplot(data = df_prop_oo,
       aes(x = Labs,
           y = Avg_Prop_Miss)) +
         geom_bar(stat = "identity") + 
          labs(title = "70 plus",x = "Labs",y = "Mean +/- Sd Proportion Missing Per Patient",fill="Site") +
  geom_errorbar(aes(ymin=pmax(Avg_Prop_Miss-sd,0),ymax = Avg_Prop_Miss + sd), width = .2,position=position_dodge(.9)) +
        coord_flip() 



require(gridExtra)
grid.arrange(prop_plot_y,prop_plot_m,prop_plot_o,prop_plot_oo,ncol=2)


```

```{R}

#Extract observations from patient_obs_wide that have days since admission between 0 and 20 and a thrombotic event code. Remove columns for patient ID and days since admisison.

te_labs <- patient_obs_wide %>%
  filter(
    days_since_admission <= 20,
    days_since_admission >= 0
  ) %>%
  mutate(te = patient_num %in% unique(te_patients$patient_num)) %>%
  select(-c(patient_num, days_since_admission))

te_labs_penn = te_labs

#Generate a ggplot of the missingness inside a dataframe. Cells are colored according to missingness (black indicates a missing cell and grey indicates a present cell). 

vis_miss_penn = vis_miss(te_labs, sort_miss = TRUE)
vis_miss_penn
```



```{R,warning=FALSE} 

#For all patients

#Calculate the Spearman correlation between lab missingness indicators to see if certain labs tend to be missing together. Isolate events from the first 100 days since admission. Then, for each time point, calculate the spearman correlation matrix for the missingness indicators for each lab. Generate a list of these matrices, and for each lab combination, see if at least 50% of the spearman correlations from each time point are > 0.5. 

#dat corresponds to the patient_obs_wide variable
#prop_greater is the desired proportion of spearman correlation values greater than the threshold
#min_corr corresponds to the threshold
#type corresponds to patient type (options are all patients ("All"), TE patients ("TE"), non-TE patients ("non-TE")). Automatically set to all patients. 
#label is how the graph should be labeled according to patient type. Automatically set to "All Patients". 

patient_obs_wide <- patient_obs %>%
  left_join(lab_bounds, by = c("concept_code" = "LOINC")) %>%
  filter(days_since_admission >= 0, !is.na(short_name)) %>%
  select(-concept_code) %>%
  pivot_wider(
    id_cols = c(patient_num, days_since_admission),
    names_from = short_name,
    values_from = value,
    values_fn = mean
  ) %>%
  left_join(select(demo_raw, patient_num, severe), by = "patient_num") %>%
  mutate(severity = factor(severe) %>%
    fct_recode("severe" = "1", "nonsevere" = "0")) %>%
  select(-severe)

dat = patient_obs_wide
min_corr = 0.5
prop_greater = 0.3

te_labs2 <- dat %>% 
  filter(days_since_admission < 100,
         days_since_admission >= 0) %>% 
  mutate(te = patient_num %in% unique(te_patients$patient_num))

#Calculate correlation matrices between lab missing indicators for each time point

sim_mat = matrix(rep(0),ncol(te_labs2)-4,ncol(te_labs2)-4)
mat_list = list()

for (h in 0:max(te_labs2$days_since_admission)){

data1 = te_labs2[which(te_labs2$days_since_admission==h),]

na_stats <- data1 %>% 
  select(- c(days_since_admission,patient_num,te,severity)) %>% 
  is.na() %>% 
  `!` 


for (i in 1:ncol(na_stats)){
  na_stats[,i] <- as.integer(as.logical(na_stats[,i]))
}

sim_mat = matrix(rep(0),ncol(na_stats),ncol(na_stats))

for (i in 1:ncol(na_stats)){
  for (j in 1:ncol(na_stats)){
    sim_mat[i,j] <- cor(na_stats[,i],na_stats[,j],method="spearman")
  }
}

rownames(sim_mat) <- colnames(na_stats)
colnames(sim_mat) <- colnames(na_stats)

mat_list[[h+1]] = sim_mat

}

#Add correlation values to a dataframe if a lab combination passes the threshold

df <- data.frame(matrix(ncol=0,nrow=length(mat_list)))
df_ind <- data.frame(matrix(ncol=0,nrow=length(mat_list)))
names = list()
final_names = c()
count = 0



for (i in 1:ncol(na_stats)){
  for (j in 1:ncol(na_stats)){
    name1 <- c(row.names(mat_list[[1]])[i],colnames(mat_list[[1]])[j])
    name1 <- do.call(paste, c(as.list(name1), sep = ", "))
    name2 <- c(row.names(mat_list[[1]])[j],colnames(mat_list[[1]])[i])
    name2 <- do.call(paste, c(as.list(name2), sep = ", "))
    if (i != j && !(name1 %in% final_names) && !(name2 %in% final_names)) {
      test_vec = c()
      indices = c()
      ct = 0
      for (h in 1:length(mat_list)){
        if (!(is.na(mat_list[[h]][i,j]))) {
          ct = ct+1
          test_vec[ct] = mat_list[[h]][i,j]
          indices[ct] = h
        }else{
          ct = ct + 1
          test_vec[ct] = test_vec[ct-1]
          indices[ct] = h
        }
      }
      
      if (mean(abs(test_vec) > min_corr) > prop_greater) {
        count = count+1
        final_names[count] = name1
        df[,count] = test_vec
        df_ind[,count] = indices
      }

    }
    }
}
  

colnames(df) <- final_names

results <- list()
results[[1]] <- df
results[[2]] <- mat_list


#Generate a heat map for the Spearman correlation between lab missingness at a given time point (in this example, second time point). Legend displays the range of Spearman correlation values. 

which_mat = 2

heatmap(results[[2]][[which_mat]],scale="none",cexRow=1,cexCol=1,margins=c(8,6))

legend(x="bottomright", legend=c(round(min(results[[2]][[which_mat]]),2),round(((max(results[[2]][[which_mat]])+min(results[[2]][[which_mat]]))/2),2), max(results[[2]][[which_mat]])), 
     fill=colorRampPalette(brewer.pal(8, "Oranges"))(3))


#Analyze spearman correlations over time for lab combinations that passed the threshold.

if ((ncol(df)) > 6){
  par(mfrow=c(ncol(df),1),omi=c(0.5,0.3,0,0), plt=c(0.1,0.9,0,0.5))
}

if ((ncol(df)) <= 12 & ncol(df) > 5) {
 if (ncol(df) %% 2 != 0) {
   par(mfrow=c((ncol(df)+1)/2,2),omi=c(0.5,0.3,0,0), plt=c(0.1,0.9,0,0.5))
 }else{
   par(mfrow=c(ncol(df)/2,2),omi=c(0.5,0.3,0,0), plt=c(0.1,0.9,0,0.5))
   
 }
}

if ((ncol(df)) <= 18 & ncol(df) > 12) {
  if (ncol(df) %% 3 == 0) {
    par(mfrow=c((ncol(df))/3,3),omi=c(0.5,0.3,0,0), plt=c(0.1,0.9,0,0.5))
  }
  if ((ncol(df)+1) %% 3 == 0) {
    par(mfrow=c((ncol(df)+1)/3,3),omi=c(0.5,0.3,0,0), plt=c(0.1,0.9,0,0.5))
  }
  if ((ncol(df)+2) %% 3 == 0) {
    par(mfrow=c((ncol(df)+2)/3,3),omi=c(0.5,0.3,0,0), plt=c(0.1,0.9,0,0.5))
  }
}
  

for (i in 1:ncol(df)){
  plot(df_ind[,i],df[,i],pch=NA,ylim=c(0,1),xlab="",ylab="")
  title(colnames(df)[i],line=.3,cex.main=.9)
  lines(df_ind[,i],df[,i],col=rainbow(ncol(df))[i])
}
mtext("Days since admission",side=1,line=2.4,outer=TRUE,cex=.8)
mtext("Spearman Correlation",side=2,line=.8,outer=TRUE,cex=.8,las=0)

highcorr_temporal_penn = df



```

```{R,warning=FALSE}

#Given list of interesting lab combinations, assess spearman correlation between lab missing indicators over time and plot. 

te_labs2 <- patient_obs_wide %>% 
  filter(days_since_admission < 100,
         days_since_admission >= 0) %>% 
  mutate(te = patient_num %in% unique(te_patients$patient_num))

#Calculate correlation matrices between lab missing indicators for each time point

sim_mat = matrix(rep(0),ncol(te_labs2)-4,ncol(te_labs2)-4)
mat_list = list()

for (h in 0:max(te_labs2$days_since_admission)){

data1 = te_labs2[which(te_labs2$days_since_admission==h),]

na_stats <- data1 %>% 
  select(- c(days_since_admission,patient_num,te,severity)) %>% 
  is.na() %>% 
  `!` 


for (i in 1:ncol(na_stats)){
  na_stats[,i] <- as.integer(as.logical(na_stats[,i]))
}

sim_mat = matrix(rep(0),ncol(na_stats),ncol(na_stats))

for (i in 1:ncol(na_stats)){
  for (j in 1:ncol(na_stats)){
    sim_mat[i,j] <- cor(na_stats[,i],na_stats[,j],method="spearman")
  }
}

rownames(sim_mat) <- colnames(na_stats)
colnames(sim_mat) <- colnames(na_stats)

mat_list[[h+1]] = sim_mat

}

#Add correlation values to a dataframe if a lab combination is interesting

df <- data.frame(matrix(ncol=0,nrow=length(mat_list)))
df_ind <- data.frame(matrix(ncol=0,nrow=length(mat_list)))
final_names = c()
names1 = list()
names2 = list()
names3 = list()
names4 = list()
names5 = list()
names1[[1]] = c("Fibrinogen","PT")
names2[[1]] = c("Creatinine","AST")
names2[[2]] = c("Creatinine","ALT")
names2[[3]] = c("Creatinine","Bilirubin")
names3[[1]] = c("PT","AST")
names3[[2]] = c("PT","ALT")
names3[[3]] = c("PT","Bilirubin")
names4[[1]] = c("Ferritin","LDH")
names5[[1]] = c("Leukocytes","AST")
names5[[2]] = c("Leukocytes","ALT")
names5[[3]] = c("Leukocytes","Bilirubin")



lab_temporal = function(name_group) {
#name_group = names1

count = 0
for (i in 1:length(name_group)){
    name <- name_group[[i]]
    name_comb <- do.call(paste, c(as.list(name), sep = ", "))
  
    test_vec = c()
    indices = c()
    ct = 0
    for (h in 1:length(mat_list)){
      if (!(is.na(mat_list[[h]][match(name[1],colnames(mat_list[[1]])),match(name[2],colnames(mat_list[[1]]))]))) {
        ct = ct+1
        test_vec[ct] = mat_list[[h]][match(name[1],colnames(mat_list[[1]])),match(name[2],colnames(mat_list[[1]]))]
        indices[ct] = h
      }else{
        ct = ct + 1
        test_vec[ct] = test_vec[ct-1]
        indices[ct] = h
      }
    }
      count = count+1
      final_names[count] = name_comb
      df[,count] = test_vec
      df_ind[,count] = indices
    }


  


colnames(df) <- final_names

results <- list()
results[[1]] <- df
results[[2]] <- mat_list


#Analyze spearman correlations over time for lab combinations that passed the threshold.

if ((ncol(df))  == 3){
  par(mfrow=c(ncol(df),1),omi=c(0.5,0.3,0,0), plt=c(0.1,0.9,0,0.5))
}

  
if (ncol(df) == 1) {
  plot(df_ind[,i],df[,i],pch=NA,ylim=c(0,1),xlab="Days since admission",ylab="Spearman Correlation")
  title(colnames(df)[i],line=.5,cex.main=1.1)
  lines(df_ind[,i],df[,i],col=rainbow(ncol(df))[i])
} 

if (ncol(df) != 1) {
for (i in 1:ncol(df)){
  plot(df_ind[,i],df[,i],pch=NA,ylim=c(0,1),xlab="",ylab="")
  title(colnames(df)[i],line=.5,cex.main=1.1)
  lines(df_ind[,i],df[,i],col=rainbow(ncol(df))[i])
}
mtext("Days since admission",side=1,line=2.2,outer=TRUE,cex=.8)
mtext("Spearman Correlation",side=2,line=.8,outer=TRUE,cex=.8,las=0)
}

return(df)

}



lab_temporal(names1)
lab_temporal(names2)
lab_temporal(names3)
lab_temporal(names4)
lab_temporal(names5)

df1 = lab_temporal(names1)
df2 = lab_temporal(names2)
df3 = lab_temporal(names3)
df4 = lab_temporal(names4)
df5 = lab_temporal(names5)

interesting_temporal_penn = cbind(df1,df2,df3,df4,df5)


```

```{r}



#Calculate proportion of existing lab values in binned days since admission (by 50 days) up to 300 days. Stratify by severe vs. non-severe.

#temporal = function(data,bins) {
binby = 50

wide =  patient_obs_wide %>% 
    filter(days_since_admission <= 300,
           days_since_admission >= 0)

wide = wide[c("patient_num","days_since_admission","Fibrinogen","Troponin_normal","Procalcitonin","FEU","Troponin_high","CRP","Ferritin","LDH","Lymphocyte","PT","Albumin","Neutrophil","AST","ALT","Bilirubin","Leukocytes","Creatinine","severity")]

total_days = max(wide$days_since_admission)
df <- data.frame(matrix(ncol=0,nrow=total_days/binby))

ct = 0
for (i in 1:(total_days/binby)) {
    dat = wide[which(wide$days_since_admission >= (ct+1) & wide$days_since_admission <= (binby+1+ct)),]
    ct = ct+binby
    dat = select(dat,-c(days_since_admission,patient_num,severity))
    for (j in 1:length(lab_names)){
        df[i,j] = (sum(is.na(dat[,j])))/nrow(dat[,j])
    }
}

df_severe = data.frame(matrix(ncol=0,nrow=total_days/binby))

ct = 0
for (i in 1:(total_days/binby)) {
    dat =wide[which(wide$days_since_admission >= (ct+1) & wide$days_since_admission <= (binby+1+ct)),]
    ct = ct+binby
    dat = dat[which(dat$severity=='severe'),]
    dat = select(dat,-c(days_since_admission,patient_num,severity))
    for (j in 1:length(lab_names)){
        df_severe[i,j] = (sum(is.na(dat[,j])))/nrow(dat[,j])
    }
}

df_nonsevere = data.frame(matrix(ncol=0,nrow=total_days/binby))

ct = 0
for (i in 1:(total_days/binby)) {
    dat = dat =wide[which(wide$days_since_admission >= (ct+1) & wide$days_since_admission <= (binby+1+ct)),]
    ct = ct + binby
    dat = dat[which(dat$severity=='nonsevere'),]
    dat = select(dat,-c(days_since_admission,patient_num,severity))
    for (j in 1:length(lab_names)){
        df_nonsevere[i,j] = (sum(is.na(dat[,j])))/nrow(dat[,j])
    }
}


df2 <- data.frame(matrix(ncol=0,nrow=nrow(df)*ncol(df)*3))

count = 0
for (i in 1:length(lab_names)){
    df2[(1+count):(3*nrow(df)+count),1] = rep(colnames(dat)[i],3*nrow(df))
    count = count+3*nrow(df)
}

bin1 = "0-50"
bin2 = "51-100"
bin3 = "101-150"
bin4 = "151-200"
bin5 = "201-250"
bin6 = "251-300"



bins = c(bin1,bin2,bin3,bin4,bin5,bin6)


df2[,2] = rep(c(bins,bins,bins),ncol(df))

c1 = rep("All patients", nrow(df))
c2 = rep("Severe patients",nrow(df))
c3 = rep("Non-severe patients",nrow(df))

ctotal = c(c1,c2,c3)
df2[,3] = rep(ctotal,ncol(df))


ct = 0
for (i in 1:ncol(df)){
    df2[(ct+1):(nrow(df)+ct),4] = df[,i]
    ct = ct + nrow(df)
    df2[(ct+1):(nrow(df)+ct),4] = df_severe[,i]
    ct = ct + nrow(df)
    df2[(ct+1):(nrow(df)+ct),4] = df_nonsevere[,i]
    ct= ct + nrow(df)
}

colnames(df2) = c("lab","days_since_admission","name","proportion")


df2$days_since_admission = factor(df2$days_since_admission,levels = bins)

level_order = c("Fibrinogen","Troponin_normal","Procalcitonin","FEU","Troponin_high","CRP","Ferritin","LDH","Lymphocyte","PT","Albumin","Neutrophil","AST","ALT","Bilirubin","Leukocytes","Creatinine")

longhaul_comb_plot = df2 %>%
    ggplot(aes(x = days_since_admission, fill = proportion, y = factor(lab,level_order))) +
    geom_tile(colour = "white", size = 0.2) +
    scale_y_discrete(expand = c(0, 0)) +
    scale_fill_gradient(low = "darkblue", high = "lightgrey") +
    facet_wrap(~name, nrow = 1) +
    labs(
      title = "Proportion of missing lab values over time",
        x = "Binned days since admission",
        y = NULL, fill = "Prop Missing"
    ) +
    
    theme(
        plot.margin=unit(c(1.02,1.6,1,0),"cm"),
        panel.grid.major = element_blank(),
        legend.position = c(1.078, 0.5),
        legend.key.height = unit(1,'cm'),
        legend.key.width=unit(.4,'cm'),
        axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5,size=6),
        axis.ticks.y = element_blank()
    )

longhaul_comb_plot

longhaul_comb_penn = df2

df2_all = df2[df2$name=="All patients",] %>%
  select(-c(name))

longhaul_plot = df2_all %>%
    ggplot(aes(x = days_since_admission, fill = proportion, y = factor(lab,level=level_order))) +
    geom_tile(colour = "white", size = 0.2) +
    scale_y_discrete(expand = c(0, 0)) +
    scale_fill_gradient(low = "darkblue", high = "lightgrey") +
    labs(
      title = "Proportion of missing lab values over time",
        x = "Binned days since admission",
        y = NULL, fill = "Prop missing"
    ) +
    
    theme(
        plot.margin=unit(c(1.02,1.6,1,0),"cm"),
        panel.grid.major = element_blank(),
        legend.position = c(1.078, 0.5),
        legend.key.height = unit(1,'cm'),
        legend.key.width=unit(.4,'cm'),
        axis.text.x = element_text(angle = 0, hjust = 1, vjust = 0.5,size=9),
        axis.ticks.y = element_blank()
    )

longhaul_plot

longhaul_penn = df2_all













#Calculate proportion of existing lab values in days since admission up to 20 days. Stratify by severe vs. non-severe.
binby = 1

wide =  patient_obs_wide %>% 
    filter(days_since_admission <= 20,
           days_since_admission >= 0)

total_days = max(wide$days_since_admission)
df <- data.frame(matrix(ncol=0,nrow=total_days/binby))

ct = 0
for (i in 1:(total_days)) {
    dat = wide[which(wide$days_since_admission >= (ct+1) & wide$days_since_admission <= (binby+1+ct)),]
    ct = ct+binby
    dat = select(dat,-c(days_since_admission,patient_num,severity))
    for (j in 1:length(lab_names)){
        df[i,j] = (sum(is.na(dat[,j])))/nrow(dat[,j])
    }
}

df_severe = data.frame(matrix(ncol=0,nrow=total_days/binby))

ct = 0
for (i in 1:(total_days/binby)) {
    dat =wide[which(wide$days_since_admission >= (ct+1) & wide$days_since_admission <= (binby+1+ct)),]
    ct = ct+binby
    dat = dat[which(dat$severity=='severe'),]
    dat = select(dat,-c(days_since_admission,patient_num,severity))
    for (j in 1:length(lab_names)){
        df_severe[i,j] = (sum(is.na(dat[,j])))/nrow(dat[,j])
    }
}

df_nonsevere = data.frame(matrix(ncol=0,nrow=total_days/binby))

ct = 0
for (i in 1:(total_days/binby)) {
    dat = dat =wide[which(wide$days_since_admission >= (ct+1) & wide$days_since_admission <= (binby+1+ct)),]
    ct = ct + binby
    dat = dat[which(dat$severity=='nonsevere'),]
    dat = select(dat,-c(days_since_admission,patient_num,severity))
    for (j in 1:length(lab_names)){
        df_nonsevere[i,j] = (sum(is.na(dat[,j])))/nrow(dat[,j])
    }
}


df2 <- data.frame(matrix(ncol=0,nrow=nrow(df)*ncol(df)*3))

count = 0
for (i in 1:length(lab_names)){
    df2[(1+count):(3*nrow(df)+count),1] = rep(colnames(dat)[i],3*nrow(df))
    count = count+3*nrow(df)
}


days = seq(1,20,1)
df2[,2] = rep(c(days,days,days),ncol(df))

c1 = rep("All patients", nrow(df))
c2 = rep("Severe patients",nrow(df))
c3 = rep("Non-severe patients",nrow(df))

ctotal = c(c1,c2,c3)
df2[,3] = rep(ctotal,ncol(df))


ct = 0
for (i in 1:ncol(df)){
    df2[(ct+1):(nrow(df)+ct),4] = df[,i]
    ct = ct + nrow(df)
    df2[(ct+1):(nrow(df)+ct),4] = df_severe[,i]
    ct = ct + nrow(df)
    df2[(ct+1):(nrow(df)+ct),4] = df_nonsevere[,i]
    ct= ct + nrow(df)
}


colnames(df2) = c("lab","days_since_admission","name","proportion")
df2$days_since_admission = factor(df2$days_since_admission,levels = bins)


level_order = c("Fibrinogen","Troponin_normal","Procalcitonin","FEU","Troponin_high","CRP","Ferritin","LDH","Lymphocyte","PT","Albumin","Neutrophil","AST","ALT","Bilirubin","Leukocytes","Creatinine")

days = seq(1,20,1)
df2[,2] = rep(c(days,days,days),ncol(df))

shorthaul_comb_penn = df2

shorthaul_comb_plot = df2 %>%
    ggplot(aes(x = days_since_admission, fill = proportion, y = factor(lab, level_order))) +
    geom_tile(colour = "white", size = 0.2) +
    scale_y_discrete(expand = c(0, 0)) +
    scale_fill_gradient(low = "darkblue", high = "lightgrey") +
    facet_wrap(~name, nrow = 1) +
    labs(title = "Proportion of missing lab values over time",
        x = "Binned days since admission",
        y = NULL, fill = "Prop missing"
    ) +
    
    theme(
        plot.margin=unit(c(1.02,1.6,1,0),"cm"),
        panel.grid.major = element_blank(),
        legend.position = c(1.078, 0.5),
        legend.key.height = unit(1,'cm'),
        legend.key.width=unit(.4,'cm'),
        axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5,size=6),
        axis.ticks.y = element_blank()
    )

shorthaul_comb_plot

df2_all = df2[df2$name=="All patients",] %>%
  select(-c(name))

shorthaul_penn = df2_all

shorthaul_plot = df2_all %>%
    ggplot(aes(x = days_since_admission, fill = proportion, y = factor(lab, level_order))) +
    geom_tile(colour = "white", size = 0.2) +
    scale_y_discrete(expand = c(0, 0)) +
    scale_fill_gradient(low = "darkblue", high = "lightgrey") +
    labs(
      title = "Proportion of missing lab values over time",
        x = "Binned days since admission",
        y = NULL, fill = "Missing"
    ) +
    
    theme(
        plot.margin=unit(c(1.02,1.6,1,0),"cm"),
        panel.grid.major = element_blank(),
        legend.position = c(1.078, 0.5),
        legend.key.height = unit(1,'cm'),
        legend.key.width=unit(.4,'cm'),
        axis.text.x = element_text(angle = 0, hjust = 1, vjust = 0.5,size=9),
        axis.ticks.y = element_blank()
    )

shorthaul_plot 

```

```{r}

#Calculate proportion of existing lab values in binned days since admission (by 20 days) up to 300 days. Stratify by TE vs. non TE


wide <- patient_obs_wide %>% 
  filter(days_since_admission < 320,
         days_since_admission >= 0) %>% 
  mutate(te = patient_num %in% unique(te_patients$patient_num))

total_days = max(wide$days_since_admission)
df <- data.frame(matrix(ncol=0,nrow=total_days/20))

ct = 0
for (i in 1:(total_days/20)) {
    dat = wide[which(wide$days_since_admission >= (ct+1) & wide$days_since_admission <= (20+1+ct)),]
    ct = ct+20
    dat = select(dat,-c(days_since_admission,patient_num,severity))
    for (j in 1:length(lab_names)){
        df[i,j] = (nrow(dat[,j])-sum(is.na(dat[,j])))/nrow(dat[,j])
    }
}

df_TE = data.frame(matrix(ncol=0,nrow=total_days/20))

ct = 0
for (i in 1:(total_days/20)) {
    dat =wide[which(wide$days_since_admission >= (ct+1) & wide$days_since_admission <= (20+1+ct)),]
    ct = ct+20
    dat = dat[which(dat$te=='TRUE'),]
    dat = select(dat,-c(days_since_admission,patient_num,severity,te))
    for (j in 1:length(lab_names)){
        df_TE[i,j] = (nrow(dat[,j])-sum(is.na(dat[,j])))/nrow(dat[,j])
    }
}

df_nonTE = data.frame(matrix(ncol=0,nrow=total_days/20))

ct = 0
for (i in 1:(total_days/20)) {
    dat = dat =wide[which(wide$days_since_admission >= (ct+1) & wide$days_since_admission <= (20+1+ct)),]
    ct = ct + 20
    dat = dat[which(dat$te=='FALSE'),]
    dat = select(dat,-c(days_since_admission,patient_num,severity,te))
    for (j in 1:length(lab_names)){
        df_nonTE[i,j] = (nrow(dat[,j])-sum(is.na(dat[,j])))/nrow(dat[,j])
    }
}


df2 <- data.frame(matrix(ncol=0,nrow=nrow(df)*ncol(df)*3))

count = 0
for (i in 1:length(lab_names)){
    df2[(1+count):(3*nrow(df)+count),1] = rep(colnames(dat)[i],3*nrow(df))
    count = count+3*nrow(df)
}

bin1 = "0-20"
bin2 = "21-40"
bin3 = "41-60"
bin4 = "61-80"
bin5 = "81-100"
bin6 = "101-120"
bin7 = "121-140"
bin8 = "141-160"
bin9 = "161-180"
bin10 = "181-200"
bin11 = "201-220"
bin12 = "221-240"
bin13 = "241-260"
bin14 = "261-280"
bin15 = "281-300"


bins = c(bin1,bin2,bin3,bin4,bin5,bin6,bin7,bin8,bin9,bin10,bin11,bin12,bin13,bin14,bin15)



df2[,2] = rep(c(bins,bins,bins),ncol(df))

c1 = rep("All patients", nrow(df))
c2 = rep("TE patients",nrow(df))
c3 = rep("Non-TE patients",nrow(df))

ctotal = c(c1,c2,c3)
df2[,3] = rep(ctotal,ncol(df))


ct = 0
for (i in 1:ncol(df)){
    df2[(ct+1):(nrow(df)+ct),4] = df[,i]
    ct = ct + nrow(df)
    df2[(ct+1):(nrow(df)+ct),4] = df_TE[,i]
    ct = ct + nrow(df)
    df2[(ct+1):(nrow(df)+ct),4] = df_nonTE[,i]
    ct= ct + nrow(df)
}

colnames(df2) = c("lab","days_since_admission","name","proportion")
df2$days_since_admission = factor(df2$days_since_admission,levels = bins)


binby20_penn = df2
binby20_plot = df2 %>%
    ggplot(aes(x = days_since_admission, fill = proportion, y = factor(lab,level_order))) +
    geom_tile(colour = "white", size = 0.2) +
    scale_y_discrete(expand = c(0, 0)) +
    scale_fill_gradient(low = "lightgrey", high = "darkblue") +
    facet_wrap(~name, nrow = 1) +
    labs(
        x = "Proportion of existing lab values in binned days since admission",
        y = NULL, fill = "Prop Existing"
    ) +
    
    theme(
        plot.margin=unit(c(1.02,1.6,1,0),"cm"),
        panel.grid.major = element_blank(),
        legend.position = c(1.078, 0.5),
        legend.key.height = unit(1,'cm'),
        legend.key.width=unit(.4,'cm'),
        axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5,size=6),
        axis.ticks.y = element_blank()
    )

binby20_plot
```



```{r}

#Plot pattern of missingness using upset plot. Visualize number of missing values for sets of data. Uses 7 sets (7 variables) and 10 intersections (10 interactions)

gg_miss_upset(te_labs, nsets = 7, nintersects = 10)

#Plot number of missings for each lab, broken down by no thrombotic event vs. presence of thrombotic event(s)

gg_miss_fct(x = te_labs, fct = te)

#Plot number of missing lab values for each observation (patient time point)

gg_miss_case(te_labs)

#Plot number of missing values for each lab

gg_miss_var(te_labs) +
  theme(
    panel.grid.minor = element_blank(),
    panel.grid.major.y = element_blank()
  ) +
  scale_y_continuous(expand = expansion(0, c(0, 1000))) +
  xlab(NULL)

#Plot percent of missing values for each lab

gg_miss_var(te_labs, show_pct = TRUE) +
  theme(
    panel.grid.minor = element_blank(),
    panel.grid.major.y = element_blank()
  ) +
  scale_y_continuous(expand = expansion(0, c(0, 1))) +
  xlab(NULL)
# mcar_test(te_labs)

# te_labs %>%
#   finalfit::missing_pairs(dependent = "te",
#                           explanatory = lab_names,
#                           position = "fill")
```


```{R}
# check NAs in the Wide format

#Create True / False dataframe for whether or not a lab is missing for each observation

na_stats <- patient_obs_wide %>%
  select(-c(patient_num, days_since_admission)) %>%
  is.na() %>%
  `!`()

#Create new dataframe containing number of values and proportion of values existing per lab 

na_df <- data.frame(
  value_existed = colSums(na_stats),
  prop_existed = colMeans(na_stats)
) %>%
  rownames_to_column("lab") %>%
  mutate(
    prop_na = 1 - prop_existed,
    lab = fct_reorder(lab, value_existed)
  )

#Plot number of values per lab

n_values <- na_df %>%
  ggplot(aes(x = value_existed, y = lab)) +
  geom_col() +
  labs(x = "Number of values", y = NULL)

#Plot proportion of values per lab. Valid value indicates existing values. 

na_prob <- na_df %>%
  rename("Valid value" = prop_existed, "NA" = prop_na) %>%
  pivot_longer(c(`Valid value`, `NA`)) %>%
  ggplot(aes(x = value, y = lab, fill = name)) +
  geom_col() +
  scale_fill_discrete(guide = guide_legend(reverse = TRUE)) +
  labs(x = "Proportion", y = NULL) +
  # guides(fill = guide_legend(reverse = TRUE))
  theme(
    axis.text.y = element_blank(),
    legend.key.width = unit(6, "mm"),
    legend.key.height = unit(4, "mm"),
    legend.position = "bottom"
  )

plot_grid(n_values, na_prob, nrow = 1, axis = "b", align = "h")

penn_na_df <- na_df
```


```{r}

#Keep the patient num and days_since_admission variables, and convert the individual lab name variables into one single variable where each observation is the name of the lab, and create another variable for the corresponding lab values. 

patient_obs_long <- patient_obs_wide %>%
  pivot_longer(-c(patient_num, days_since_admission, severity),
    names_to = "lab", values_to = "value",
    values_drop_na = TRUE
  )
```


```{r fig.show='hide'}
# number of patients per lab value

#For an individual lab, obtain number of lab observations per patient. Plot a histogram of the number of lab observations for each patient. Create dataframe containing counts and density for each lab.

get_pat_labs <- function(labi) {
  patients_labs <- patient_obs_long %>%
    filter(lab == labi) %>%
    count(patient_num) %>%
    pull(n) %>%
    hist(., breaks = seq(0, max(.), 1), main = labi)

  patients_labs[[1]] <- patients_labs[[1]][-1]
  data.frame(
    do.call(cbind.data.frame, patients_labs[1:3]),
    lab = labi
  )
}

#Run function for each lab and bind the rows from each dataframe

patient_lab <- lapply(unique(patient_obs_long$lab), get_pat_labs) %>%
  bind_rows()

penn_patient_lab <- patient_lab


#Replicate each row by the length of the dataframe

melt_patient_lab <- patient_lab[rep(1:nrow(patient_lab), patient_lab$counts), ]
```

```{r}
melt_patient_lab %>%
  filter(breaks < 30) %>%
  mutate(lab = fct_infreq(lab)) %>%
  ggplot(aes(x = breaks, y = lab, fill = lab, height = ..count..)) +
  # geom_density_ridges(stat = "identity", scale = 2) +
  geom_ridgeline(stat = "binline", binwidth = 1, scale = 0.001) +
  # scale_color_viridis_d(option = 'C') +
  scale_fill_viridis_d(option = "C", guide = FALSE) +
  labs(y = NULL) +
  # coord_flip() +
  # facet_wrap(~ lab, scales = 'free') +
  NULL
```


## Number of observation (days) per patient
```{R}
days_count_min_max <-
  # multiple_imps %>%
  patient_obs_wide %>%
  group_by(patient_num, severity) %>%
  summarise(
    n_values = n_distinct(days_since_admission),
    min_day = min(days_since_admission),
    max_day = max(days_since_admission),
    .groups = "drop"
  ) %>%
  # left_join(demo_raw, by = "patient_num") %>%
  # mutate(time_obs = max_day - min_day,
  #        severity = factor(severe)) %>%
  # select(-patient_num) %>%
  add_count(severity, name = "n_severity") %>%
  {
    .
  }

penn_agg_n_values <- days_count_min_max %>%
  count(severity, n_severity, n_values,
    name = "n_nvals"
  )
penn_agg_max_day <- days_count_min_max %>%
  count(severity, n_severity, max_day,
    name = "n_maxday"
  )

penn_agg_n_values %>%
  ggplot(aes(x = n_nvals)) +
  geom_bar()

(n_severe <- sum(days_count_min_max$severity == "severe"))
(n_nonsevere <- sum(days_count_min_max$severity == "nonsevere"))
```

## Histogram of the number of days with at least one observation
```{R}
penn_agg_n_values %>%
  ggplot(aes(x = n_values, y = n_nvals, fill = severity)) +
  geom_col(alpha = 0.5) +
  scale_fill_brewer(palette = "Dark2", direction = -1) +
  labs(
    fill = "Severe?",
    x = "Number of days with data",
    y = "Count"
  )
```

## Histogram of length of stay
i.e. last day with observation-first day with observation

We need to check for readmission here.
```{R}
penn_agg_max_day %>%
  ggplot(aes(x = max_day, y = n_maxday, fill = severity)) +
  geom_col(alpha = 0.5) +
  scale_fill_brewer(palette = "Dark2", direction = -1) +
  labs(
    fill = "Severe?",
    x = "Number of days with data",
    y = "Count"
  )
```

## Analyze missingness and frequency of measures for each lab

```{r}

#Count the number of observations for each individual patient.  Then count the number of patients that have x severe observations and z nonsevere observations for a given lab (for the range of x and z observations for a given lab). Add a column for both severities. Add another column for the proportion of severe patients that have x severe observations for a given lab out of all severe patients. Do this for non-severe and both severities. 

per_lab <- patient_obs_long %>%
  group_by(lab, patient_num, severity) %>%
  count(name = "n_obs") %>%
  ungroup() %>%
  group_by(lab, severity) %>%
  count(n_obs) %>%
  ungroup() %>%
  pivot_wider(names_from = severity, values_from = n, values_fill = 0) %>%
  mutate(both_severities = nonsevere + severe) %>%
  mutate(
    prop_nonsevere = nonsevere / n_nonsevere,
    prop_severe = severe / n_severe,
    prop_both = both_severities / nrow(days_count_min_max)
  )

lab_medians <-
  patient_obs_long %>%
  add_count(lab, name = "total_obs") %>%
  group_by(lab) %>%
  mutate(total_patients = length(unique(patient_num))) %>%
  add_count(patient_num, name = "n_obs_patients") %>%
  mutate(
    median_obs_per_patient = median(n_obs_patients),
    n_greater0 = n_obs_patients > median_obs_per_patient,
    n_greater1 = n_obs_patients > median_obs_per_patient + 1,
    n_greater2 = n_obs_patients > median_obs_per_patient + 2
  ) %>%
  group_by(severity) %>%
  mutate(each_med_obs_per_patient = median(n_obs_patients)) %>%
  ungroup(severity) %>%
  select(-c(days_since_admission, value)) %>%
  distinct() %>%
  group_by(lab) %>%
  mutate(across(contains("n_greater"), sum)) %>%
  select(-c(n_obs_patients, patient_num)) %>%
  distinct() %>%
  pivot_wider(names_from = severity, values_from = each_med_obs_per_patient) %>%
  rename(
    "median_obs_per_severe_patient" = severe,
    "median_obs_per_non_severe_patient" = nonsevere
  ) %>%
  select(lab, total_obs, total_patients, starts_with("med"), starts_with("n_"))

lab_medians %>%
  datatable(rownames = FALSE)
```


`n_greater0` shows the number of patients who had more observations than the median.
`n_greater1` shows the number of patients who had more observations than the median + 1.
`n_greater2` shows the number of patients who had more observations than the median + 2.

```{r eval=FALSE, include=FALSE}
lab_medians %>%
  select(lab, total_obs, total_patients) %>%
  pivot_longer(-lab) %>%
  ggplot(aes(x = value, y = fct_reorder(lab, value))) +
  geom_col() +
  facet_grid(cols = vars(name), scales = "free_x", space = "free") +
  labs(y = NULL)
```

In the figure below:

- Grey dash line: `Reference Low`
- Grey solid line: `Reference High`
- Black dash line: `lower bound outlier` (QC)
- Black solid line: `upper bound outlier` (QC)

```{r fig.width=9, fig.height=11}
patient_obs_long %>%
  left_join(lab_bounds, by = c("lab" = "short_name")) %>%
  ggplot(aes(y = severity, x = value, fill = severity)) +
  geom_violin() +
  scale_fill_brewer(palette = "Dark2", guide = guide_legend(reverse = TRUE)) +
  labs(y = NULL, x = NULL) +
  geom_vline(aes(xintercept = `Reference Low`), linetype = "dashed", color = "grey") +
  geom_vline(aes(xintercept = `Reference High`), color = "grey") +
  geom_vline(aes(xintercept = LB), linetype = "dashed") +
  geom_vline(aes(xintercept = UB)) +
  facet_wrap(~lab, scales = "free", ncol = 2, strip.position = "left") +
  theme(axis.text.y = element_blank())
```

## Missing data heatmap

"Binned" heatmap

```{r fig.width=12}

#Generate a heatmap in which darker purple colors indicate a higher proportion of patients in a given bin (detailing the number of values a patient has for a given lab). 

per_lab %>%
  mutate(obs_bin = cut(
    n_obs,
    breaks = c(0:15, 20, 30, max(n_obs))
  )) %>%
  group_by(lab, obs_bin) %>%
  summarise(
    both_severities = sum(both_severities),
    severe = sum(severe),
    nonsevere = sum(nonsevere),
    .groups = "drop"
  ) %>%
  select(lab, obs_bin, both_severities, severe, nonsevere) %>%
  pivot_longer(c(both_severities, severe, nonsevere)) %>%
  mutate(name = name %>% fct_recode(
    "All patients" = "both_severities",
    "Severe patients" = "severe",
    "Non-severe patients" = "nonsevere"
  )) %>%
  ggplot(aes(x = obs_bin, fill = value, y = fct_reorder(lab, value))) +
  geom_tile(colour = "white", size = 0.2) +
  geom_text(aes(label = value), colour = "white", size = 2) +
  scale_y_discrete(expand = c(0, 0)) +
  scale_fill_gradient(low = "lightgrey", high = "darkblue") +
  facet_wrap(~name, nrow = 1) +
  labs(
    x = "Binned number of values a patient has for each lab",
    y = NULL, fill = "# patients"
  ) +
  theme(
    panel.grid.major = element_blank(),
    legend.position = c(0.93, 0.2),
    axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5),
    axis.ticks.y = element_blank()
  )
```


```{r fig.width=12}

bin_nobs = per_lab %>%
  mutate(obs_bin = cut(n_obs, breaks = c(0:15, 20, 30, max(n_obs)))) %>%
  group_by(lab, obs_bin) %>%
  summarise(
    prop_both = sum(prop_both, na.rm = TRUE),
    prop_severe = sum(prop_severe, na.rm = TRUE),
    prop_nonsevere = sum(prop_nonsevere, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  select(lab, obs_bin, prop_both, prop_severe, prop_nonsevere) %>%
  pivot_longer(c(prop_both, prop_severe, prop_nonsevere)) %>%
  mutate(name = name %>% fct_recode(
    "Compared to all patients" = "prop_both",
    "Compared to all severe patients" = "prop_severe",
    "Compared to all non-severe patients" = "prop_nonsevere"
  ))
binnobs_plot = bin_nobs %>% ggplot(aes(x = obs_bin, fill = value, y = fct_reorder(lab, value))) +
  geom_tile(colour = "white", size = 0.2) +
  geom_text(aes(label = round(value, 2)), colour = "white", size = 2) +
  scale_y_discrete(expand = c(0, 0)) +
  scale_fill_gradient(
    low = "lightgrey", high = "darkblue",
    labels = scales::percent_format(accuracy = 1L)
  ) +
  facet_wrap(~name, nrow = 1) +
  labs(
    x = "Binned number of values a patient has for each lab",
    y = NULL, fill = "% patients"
  ) +
  theme(
    panel.grid.major = element_blank(),
    legend.position = c(0.93, 0.2),
    axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5),
    axis.ticks.y = element_blank()
  )

bin_nobs_penn = bin_nobs
binnobs_plot

```

Denominator: total number of patients, total number of non-severe patients,
and total number of severe patients, respectively.

```{r}
per_lab %>%
  select(lab, n_obs, severe, nonsevere) %>%
  filter(n_obs <= 90) %>%
  pivot_longer(c(severe, nonsevere)) %>%
  mutate(
    lab = fct_reorder(lab, n_obs),
    name = name %>% fct_recode(
      "Severe patients" = "severe",
      "Non-severe patients" = "nonsevere"
    )
  ) %>%
  ggplot(aes(x = n_obs, fill = name, y = value)) +
  geom_col() +
  scale_fill_brewer(palette = "Dark2", direction = -1) +
  facet_wrap(~lab, scales = "free") +
  labs(
    x = "Number of values a patient has for each lab",
    y = NULL, fill = "# patients"
  ) +
  theme(
    panel.grid.major = element_blank(),
    legend.position = c(0.9, 0.2),
    axis.ticks.y = element_blank()
  )
```


```{r}
sessionInfo()
```

```{r}
save(penn_na_df, penn_patient_lab, penn_agg_n_values, penn_agg_max_day,df_prop_penn,df_num_penn,df_prop_Sex_penn,df_prop_Severity_penn,df_prop_Race_penn,df_prop_Age_penn,te_labs_penn,highcorr_temporal_penn,interesting_temporal_penn,longhaul_comb_penn,longhaul_penn,shorthaul_comb_penn,shorthaul_penn,binby20_penn,bin_nobs_penn,
  file = "results/penn-results-quantify-missingness.Rdata"
)

ggsave('figs/prop_plot_penn.png', prop_plot)
ggsave('figs/num_plot_penn.png',num_plot)
ggsave('figs/prop_plot_Sex_penn.png',prop_plot_Sex)
ggsave('figs/prop_plot_Severity_penn.png',prop_plot_Severity)
ggsave('figs/vis_miss_penn.png',vis_miss_penn)
ggsave('figs/longhaul_comb_plot_penn.png',longhaul_comb_plot)
ggsave('figs/longhaul_plot_penn.png',longhaul_plot)
ggsave('figs/shorthaul_comb_plot_penn.png',shorthaul_comb_plot)
ggsave('figs/shorthaul_plot_penn.png',shorthaul_plot)
ggsave('figs/binby20_plot_penn.png',binby20_plot)
ggsave('figs/binnobs_plot_penn.png',binnobs_plot)
ggsave('figs/prop_plot_diff_sex_penn.png',prop_plot_diff_sex_penn)
ggsave('figs/prop_plot_diff_severity_penn.png',prop_plot_diff_severity_penn)


```
