---
title: "Missingness analysis"
author: Amelia Tan, Arianna Dagliati, Trang Le, Emily Getzen
date: "29 July 2021"
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, output_dir = "htmls") })
---
```{r setup}
source("R/utils.R")
required_pkgs <- c("tidyverse", "lubridate", "ggridges", "cowplot", "naniar", "DT","RColorBrewer","mSTEM",'Rcpp')
install_required(required_pkgs)

library(tidyverse)
library(DT)
library(lubridate)
library(naniar)
library(cowplot)
library(ggridges)
library(RColorBrewer)
library(mSTEM)
library(Rcpp)

theme_set(theme_bw())
theme_update(
  legend.title = element_blank(),
  panel.grid.minor = element_blank()
)
```



## Read in files. Get TE patients and AKI patients. 
```{r warning=FALSE, message=FALSE}

#Read in local patient summary: Change data_dir to the folder where your data files are located

data_dir <- "/users/emily/Downloads"

#Change dateFormat to the date format of your data

dateFormat <- "%d-%b-%y"

demo_raw <-
  readr::read_csv(
    file.path(data_dir, "LocalPatientSummary.csv"),
    col_types = list(patient_num = readr::col_character()),
    na = "1900-01-01"
  ) %>%
  mutate(across(ends_with("_date") & where(is.character), lubridate::mdy)) %>%
  mutate(
    last_discharge_date = if_else(
      !is.na(death_date) & death_date < last_discharge_date,
      death_date,
      last_discharge_date
    )
  )


#Read in thrombotic icd codes. Add column "truncated code" for first three characters of each code. Extract unique truncated codes. 

thrombo_codes <- read_csv("https://raw.githubusercontent.com/covidclinical/Phase2.1AKIRPackage/ac19716a4586f45c398728fcd821ca9d5baffe45/FourCePhase2.1AKI/data-raw/thromb_icd_code.csv") %>%
  mutate(truncated_code = substr(icd_code, 1, 3)) %>%
  pull(truncated_code) %>%
  unique()

#Extract information for patients with codes for thrombotic events

patient_obs <- read_csv(
  file.path(data_dir, "LocalPatientObservations.csv"),
  col_types = list(patient_num = readr::col_character()),
  na = "-999"
)

te_patients <- patient_obs %>%
  filter(
    concept_type == "DIAG-ICD10",
    concept_code %in% thrombo_codes,
    days_since_admission >= 0
  )
```


```{R message=FALSE}
# 4CE long format Labs Data


# Code, Descriptions and Ranges
lab_mapping <- read_csv("public-data/loinc-map.csv")
lab_bounds <- read_csv("public-data/lab_bounds.csv")
lab_names <- lab_bounds$short_name

# load('public-data/code.dict.rda')
```

```{R}
# setdiff(patient_obs$concept_code %>% unique(), lab_bounds$LOINC)

#Generate a table that contains information about each lab for each individual patient. Clean up data by removing observations with missing lab names or < 0 days since admission. Each observation is identified by their patient number and days since admission, and each lab name and value is included. If there is more than one lab value for that identifier, they are averaged. Also add severity column. 

patient_obs_wide <- patient_obs %>%
  left_join(lab_bounds, by = c("concept_code" = "LOINC")) %>%
  filter(days_since_admission >= 0, !is.na(short_name)) %>%
  select(-concept_code) %>%
  pivot_wider(
    id_cols = c(patient_num, days_since_admission),
    names_from = short_name,
    values_from = value,
    values_fn = mean
  ) %>%
  left_join(select(demo_raw, patient_num, severe), by = "patient_num") %>%
  mutate(severity = factor(severe) %>%
    fct_recode("severe" = "1", "nonsevere" = "0")) %>%
  select(-severe)

#Specify lab ordering so that analyses are easy to consolidate across sites
#If your site has additional labs, please add them at the end of allLabs:

allLabs <- c("Fibrinogen","Troponin_normal","Procalcitonin","FEU","Troponin_high","CRP","Ferritin","LDH","Lymphocyte","PT","Albumin","Neutrophil","AST","ALT","Bilirubin","Leukocytes","Creatinine")
labsPresent <- allLabs[ allLabs %in% colnames(patient_obs_wide)]

#Extract unique lab names

lab_names <- intersect(lab_bounds$short_name, names(patient_obs_wide))


Severe_pats <- demo_raw[demo_raw$severe == 1,]
wide <- patient_obs_wide %>% mutate(severe = patient_num %in% unique(Severe_pats$patient_num)) 
Severe_patients <- wide[wide$severe==1,]
Nonsevere_patients <- wide[wide$severe==0,]


```


```{R}


avgs = patient_obs_wide[FALSE,] %>% select(-c(patient_num,days_since_admission,severity))

props = patient_obs_wide[FALSE,] %>% select(-c(patient_num,days_since_admission,severity))
ct = 1
for (i in 1:length(unique(patient_obs_wide$patient_num))) {
  for (j in 1:ncol(avgs)) {
    dat <- filter(patient_obs_wide,patient_num==i)
    if (nrow(dat) != 0){
      num_miss = sum(is.na(dat[j+2]))
      avgs[ct,j] = num_miss
      props[ct,j] = num_miss/(nrow(dat[j+2]))
      if ( j == ncol(avgs)){
        ct = ct + 1
      }
    }
  }
}

dat_prop = colMeans(props)
dat_sd_prop = apply(props,2,sd)
dat_num = colMeans(avgs)
dat_sd_num = apply(avgs,2,sd)
site = rep("Penn",length(dat_prop))
df_prop = data.frame(Labs = colnames(avgs), Avg_Prop_Miss = dat_prop,sd = dat_sd_prop,Site=site)
df_num = data.frame(Labs = colnames(avgs), Avg_Num_Miss = dat_num,sd = dat_sd_num,Site=site)

df_prop$Labs <- factor(df_prop$Labs,levels = labsPresent)
df_num$Labs <- factor(df_prop$Labs,levels = labsPresent )


prop_plot = ggplot(data = df_prop,
       aes(x = Labs,
           y = Avg_Prop_Miss,
           fill = Site)) +
         geom_bar(stat = "identity") + 
          labs(x = "Labs",y = "Mean +/- Sd Proportion Missing Per Patient",fill="Site") +
  theme(axis.text.x=element_text(angle=90,vjust = 0.5, hjust=1)) +
        geom_errorbar(aes(ymin=pmax(Avg_Prop_Miss-sd,0),ymax = pmin(Avg_Prop_Miss + sd,1)), width = .2,position=position_dodge(.9)) 

prop_plot 

num_plot = ggplot(data = df_num,
       aes(x = Labs,
           y = Avg_Num_Miss,
           fill = Site)) +
         geom_bar(stat = "identity") + 
          labs(x = "Labs",y = "Average Number Missing Per Patient",fill="Site") +
  theme(axis.text.x=element_text(angle=90,vjust = 0.5, hjust=1)) +
    geom_errorbar(aes(ymin=pmax(Avg_Num_Miss-sd,0),ymax = Avg_Num_Miss + sd), width = .2,position=position_dodge(.9)) 

num_plot

df_prop_penn = df_prop
df_num_penn = df_num

require(gridExtra)
grid.arrange(prop_plot,num_plot,ncol=1)

props_penn = props






```
```{R}

#Stratify by sex!

props_M = patient_obs_wide[FALSE,] %>% select(-c(patient_num,days_since_admission,severity))
props_F = patient_obs_wide[FALSE,] %>% select(-c(patient_num,days_since_admission,severity))

indices_M = which(demo_raw$sex=="male")
indices_F = which(demo_raw$sex=="female")

ct = 1
for (i in 1:length(as.integer(unique(patient_obs_wide$patient_num)))) {
  if (as.integer(unique(patient_obs_wide$patient_num))[i] %in% indices_M){
  
  for (j in 1:ncol(props_M)) {
    dat <- filter(patient_obs_wide,patient_num==i)
    if (nrow(dat) != 0){
      num_miss = sum(is.na(dat[j+2]))
      props_M[ct,j] = num_miss/(nrow(dat[j+2]))
      if ( j == ncol(props_M)){
        ct = ct + 1
      }
    }
  }
  }
}


ct = 1
for (i in 1:length(as.integer(unique(patient_obs_wide$patient_num)))) {
  if (as.integer(unique(patient_obs_wide$patient_num))[i] %in% indices_F){
  for (j in 1:ncol(props_F)) {
    dat <- filter(patient_obs_wide,patient_num==i)
    if (nrow(dat) != 0){
      num_miss = sum(is.na(dat[j+2]))
      props_F[ct,j] = num_miss/(nrow(dat[j+2]))
      if ( j == ncol(props_F)){
        ct = ct + 1
      }
    }
  }
  }
}



dat_prop_M = colMeans(props_M)
dat_prop_F = colMeans(props_F)
dat_sd_M= apply(props_M,2,sd)
dat_sd_F= apply(props_F,2,sd)
diff = dat_prop_M-dat_prop_F

sex_M = rep("Male",length(dat_prop_M))
sex_F = rep("Female",length(dat_prop_F))
df_prop_M = data.frame(Labs = colnames(props_M), Avg_Prop_Miss = dat_prop_M,sd = dat_sd_M,Sex=sex_M)
df_prop_M$Labs <- factor(df_prop_M$Labs,levels =labsPresent)
df_prop_F = data.frame(Labs = colnames(props_F), Avg_Prop_Miss = dat_prop_F,sd = dat_sd_F,Sex=sex_F)
df_prop_F$Labs <- factor(df_prop_F$Labs,levels = labsPresent)
df_prop_diff_sex = data.frame(Labs = colnames(props_F), Avg_Prop_Miss = diff)
df_prop_diff_sex$Labs <- factor(df_prop_diff_sex$Labs,levels = labsPresent)



df_prop_Sex = rbind(df_prop_M,df_prop_F)
site = rep("Penn",nrow(df_prop_Sex))
df_prop_Sex$Site = site
df_prop_Sex_penn <- df_prop_Sex

prop_plot_Sex = ggplot(data = df_prop_Sex,
       aes(x = Labs,
           y = Avg_Prop_Miss,
           fill = Sex)) +
         geom_bar(stat = "identity",width=0.8,position=position_dodge()) + 
          labs(title = "Stratified by Sex", x = "Labs",y = "Mean +/- Sd Proportion Missing Per Patient",fill="Sex")+
  theme(axis.text.x=element_text(angle=90,vjust = 0.5, hjust=1)) +
    geom_errorbar(aes(ymin=pmax(Avg_Prop_Miss-sd,0),ymax = Avg_Prop_Miss + sd), width = .1,position=position_dodge(.9)) 

prop_plot_Sex

df_prop_diff_sex_penn = df_prop_diff_sex
Site = rep("Penn",nrow(df_prop_diff_sex_penn))
df_prop_diff_sex_penn$site = Site


prop_plot_diff_sex_penn = ggplot(data = df_prop_diff_sex_penn,
       aes(x = reorder(Labs,Avg_Prop_Miss),
           y = Avg_Prop_Miss,
           fill = site)) +
         geom_bar(stat = "identity") + 
          labs(title = "Stratified by Sex",x = "Labs",y = "Mean Difference in Proportion Missing Per Patient",fill="Site") +
  theme(axis.text.x=element_text(angle=90,vjust = 0.5, hjust=1)) 

prop_plot_diff_sex_penn


#Stratify by severity!


props_S = patient_obs_wide[FALSE,] %>% select(-c(patient_num,days_since_admission,severity))
props_NS = patient_obs_wide[FALSE,] %>% select(-c(patient_num,days_since_admission,severity))

indices_S = which(demo_raw$severe==1)
indices_NS = which(demo_raw$severe==0)

ct = 1
for (i in 1:length(as.integer(unique(patient_obs_wide$patient_num)))) {
  if (as.integer(unique(patient_obs_wide$patient_num))[i] %in% indices_S){
  
  for (j in 1:ncol(props_S)) {
    dat <- filter(patient_obs_wide,patient_num==i)
    if (nrow(dat) != 0){
      num_miss = sum(is.na(dat[j+2]))
      props_S[ct,j] = num_miss/(nrow(dat[j+2]))
      if ( j == ncol(props_S)){
        ct = ct + 1
      }
    }
  }
  }
}


ct = 1
for (i in 1:length(as.integer(unique(patient_obs_wide$patient_num)))) {
  if (as.integer(unique(patient_obs_wide$patient_num))[i] %in% indices_NS){
  for (j in 1:ncol(props_NS)) {
    dat <- filter(patient_obs_wide,patient_num==i)
    if (nrow(dat) != 0){
      num_miss = sum(is.na(dat[j+2]))
      props_NS[ct,j] = num_miss/(nrow(dat[j+2]))
      if ( j == ncol(props_NS)){
        ct = ct + 1
      }
    }
  }
  }
}


dat_prop_S = colMeans(props_S)
dat_prop_NS = colMeans(props_NS)
dat_sd_prop_S = apply(props_S,2,sd)
dat_sd_prop_NS = apply(props_NS,2,sd)
diff = dat_prop_S-dat_prop_NS

severe = rep("Severe",length(dat_prop_S))
non_severe = rep("Non-Severe",length(dat_prop_NS))
df_prop_S = data.frame(Labs = colnames(props_S), Avg_Prop_Miss = dat_prop_S,sd = dat_sd_prop_S,severity = severe)
df_prop_S$Labs <- factor(df_prop_S$Labs,levels =labsPresent)
df_prop_NS = data.frame(Labs = colnames(props_NS), Avg_Prop_Miss = dat_prop_NS,sd = dat_sd_prop_NS,severity = non_severe)
df_prop_NS$Labs <- factor(df_prop_NS$Labs,levels = labsPresent)
df_prop_diff_severity = data.frame(Labs = colnames(props_S), Avg_Prop_Miss = diff)
df_prop_diff_severity$Labs <- factor(df_prop_diff_severity$Labs,levels = labsPresent)


df_prop_Severity = rbind(df_prop_S,df_prop_NS)
site = rep("Penn",nrow(df_prop_Severity))
df_prop_Severity$Site = site

prop_plot_Severity = ggplot(data = df_prop_Severity,
       aes(x = Labs,
           y = Avg_Prop_Miss,
           fill = severity)) +
         geom_bar(stat = "identity",width=0.8,position=position_dodge()) + 
          labs(title = "Stratified by Severity",x = "Labs",y = "Mean +/- Sd Proportion Missing Per Patient",fill="Severity")+
  theme(axis.text.x=element_text(angle=90,vjust = 0.5, hjust=1)) +
    geom_errorbar(aes(ymin=pmax(Avg_Prop_Miss-sd,0),ymax = Avg_Prop_Miss + sd), width = .1,position=position_dodge(.9)) 

prop_plot_Severity

df_prop_Severity_penn = df_prop_Severity

df_prop_diff_Severity_penn = df_prop_diff_severity
Site = rep("Penn",nrow(df_prop_diff_Severity_penn))
df_prop_diff_Severity_penn$site = Site



prop_plot_diff_severity_penn = ggplot(data = df_prop_diff_Severity_penn,
       aes(x = reorder(Labs,Avg_Prop_Miss),
           y = Avg_Prop_Miss,
           fill = Site)) +
         geom_bar(stat = "identity") + 
          labs(title = "Stratified by Severity",x = "Labs",y = "Mean Difference in Proportion Missing Per Patient",fill="Site") +
  theme(axis.text.x=element_text(angle=90,vjust = 0.5, hjust=1)) 

prop_plot_diff_severity_penn



props_M_penn = props_M
props_F_penn = props_F
props_S_penn = props_S
props_NS_penn = props_NS


```





```{R,warning=FALSE} 

#For all patients

#Calculate the Spearman correlation between lab missingness indicators to see if certain labs tend to be missing together. 

#dat corresponds to the patient_obs_wide variable
#prop_greater is the desired proportion of spearman correlation values greater than the threshold
#min_corr corresponds to the threshold
#type corresponds to patient type (options are all patients ("All"), TE patients ("TE"), non-TE patients ("non-TE")). Automatically set to all patients. 
#label is how the graph should be labeled according to patient type. Automatically set to "All Patients". 

demo_raw$date_diff <- as.Date(as.character(demo_raw$last_discharge_date), format="%Y-%m-%d")-
                  as.Date(as.character(demo_raw$admission_date), format="%Y-%m-%d")

patient_obs_wide <- patient_obs %>%
  left_join(lab_bounds, by = c("concept_code" = "LOINC")) %>%
  filter(days_since_admission >= 0, !is.na(short_name)) %>%
  select(-concept_code) %>%
  pivot_wider(
    id_cols = c(patient_num, days_since_admission),
    names_from = short_name,
    values_from = value,
    values_fn = mean
  ) %>%
  left_join(select(demo_raw, patient_num, severe), by = "patient_num") %>%
  mutate(severity = factor(severe) %>%
    fct_recode("severe" = "1", "nonsevere" = "0")) %>%
  select(-severe)

dates_diff = c()
for (i in 1:nrow(demo_raw)){
  dates_diff = c(dates_diff,rep(demo_raw$date_diff[i],sum(patient_obs_wide$patient_num==i)))
}

patient_obs_wide = patient_obs_wide[patient_obs_wide$days_since_admission <= dates_diff,]

dat = patient_obs_wide
min_corr = 0
prop_greater = 0

te_labs2 <- dat %>% 
  filter(days_since_admission < 100,
         days_since_admission >= 0) %>% 
  mutate(te = patient_num %in% unique(te_patients$patient_num))

#Calculate correlation matrices between lab missing indicators for each time point

sim_mat = matrix(rep(0),ncol(te_labs2)-4,ncol(te_labs2)-4)
mat_list = list()

for (h in 0:max(te_labs2$days_since_admission)){

data1 = te_labs2[which(te_labs2$days_since_admission==h),]

na_stats <- data1 %>% 
  select(- c(days_since_admission,patient_num,te,severity)) %>% 
  is.na() %>% 
  `!` 


for (i in 1:ncol(na_stats)){
  na_stats[,i] <- as.integer(as.logical(na_stats[,i]))
}

sim_mat = matrix(rep(0),ncol(na_stats),ncol(na_stats))

for (i in 1:ncol(na_stats)){
  for (j in 1:ncol(na_stats)){
    if (nrow(na_stats) >= 5) {
      sim_mat[i,j] <- cor(na_stats[,i],na_stats[,j],method="spearman")
    }
  }
}

rownames(sim_mat) <- colnames(na_stats)
colnames(sim_mat) <- colnames(na_stats)

mat_list[[h+1]] = sim_mat

}

#Add correlation values to a dataframe if a lab combination passes the threshold

df <- data.frame(matrix(ncol=0,nrow=length(mat_list)))
df_ind <- data.frame(matrix(ncol=0,nrow=length(mat_list)))
names = list()
final_names = c()
count = 0



for (i in 1:ncol(na_stats)){
  for (j in 1:ncol(na_stats)){
    name1 <- c(row.names(mat_list[[1]])[i],colnames(mat_list[[1]])[j])
    name1 <- do.call(paste, c(as.list(name1), sep = ", "))
    name2 <- c(row.names(mat_list[[1]])[j],colnames(mat_list[[1]])[i])
    name2 <- do.call(paste, c(as.list(name2), sep = ", "))
    if (i != j && !(name1 %in% final_names) && !(name2 %in% final_names)) {
      test_vec = c()
      indices = c()
      ct = 0
      for (h in 1:length(mat_list)){
        if (!(is.na(mat_list[[h]][i,j]))) {
          ct = ct+1
          test_vec[ct] = mat_list[[h]][i,j]
          indices[ct] = h
        }else{
          ct = ct + 1
          test_vec[ct] = test_vec[ct-1]
          indices[ct] = h
        }
      }
      
      if (mean(abs(test_vec) > min_corr) > prop_greater) {
        count = count+1
        final_names[count] = name1
        df[,count] = test_vec
        df_ind[,count] = indices
      }

    }
    }
}
  

colnames(df) <- final_names

results <- list()
results[[1]] <- df
results[[2]] <- mat_list


temporal_penn = df

#Get df for severe

dat = patient_obs_wide
dat = dat[dat$severity=='severe',]
min_corr = 0
prop_greater = 0

te_labs2 <- dat %>% 
  filter(days_since_admission < 100,
         days_since_admission >= 0) %>% 
  mutate(te = patient_num %in% unique(te_patients$patient_num))

#Calculate correlation matrices between lab missing indicators for each time point

sim_mat = matrix(rep(0),ncol(te_labs2)-4,ncol(te_labs2)-4)
mat_list = list()

for (h in 0:max(te_labs2$days_since_admission)){

data1 = te_labs2[which(te_labs2$days_since_admission==h),]

na_stats <- data1 %>% 
  select(- c(days_since_admission,patient_num,te,severity)) %>% 
  is.na() %>% 
  `!` 


for (i in 1:ncol(na_stats)){
  na_stats[,i] <- as.integer(as.logical(na_stats[,i]))
}

sim_mat = matrix(rep(0),ncol(na_stats),ncol(na_stats))

for (i in 1:ncol(na_stats)){
  for (j in 1:ncol(na_stats)){
    if (nrow(na_stats) >= 5) {
      sim_mat[i,j] <- cor(na_stats[,i],na_stats[,j],method="spearman")
    }
  }
}

rownames(sim_mat) <- colnames(na_stats)
colnames(sim_mat) <- colnames(na_stats)

mat_list[[h+1]] = sim_mat

}

#Add correlation values to a dataframe if a lab combination passes the threshold

df <- data.frame(matrix(ncol=0,nrow=length(mat_list)))
df_ind <- data.frame(matrix(ncol=0,nrow=length(mat_list)))
names = list()
final_names = c()
count = 0



for (i in 1:ncol(na_stats)){
  for (j in 1:ncol(na_stats)){
    name1 <- c(row.names(mat_list[[1]])[i],colnames(mat_list[[1]])[j])
    name1 <- do.call(paste, c(as.list(name1), sep = ", "))
    name2 <- c(row.names(mat_list[[1]])[j],colnames(mat_list[[1]])[i])
    name2 <- do.call(paste, c(as.list(name2), sep = ", "))
    if (i != j && !(name1 %in% final_names) && !(name2 %in% final_names)) {
      test_vec = c()
      indices = c()
      ct = 0
      for (h in 1:length(mat_list)){
        if (!(is.na(mat_list[[h]][i,j]))) {
          ct = ct+1
          test_vec[ct] = mat_list[[h]][i,j]
          indices[ct] = h
        }else{
          ct = ct + 1
          test_vec[ct] = test_vec[ct-1]
          indices[ct] = h
        }
      }
      
      if (mean(abs(test_vec) > min_corr) > prop_greater) {
        count = count+1
        final_names[count] = name1
        df[,count] = test_vec
        df_ind[,count] = indices
      }

    }
    }
}
  

colnames(df) <- final_names

results <- list()
results[[1]] <- df
results[[2]] <- mat_list

temporal_severe_penn = df

#get df for non-severe

dat = patient_obs_wide
dat = dat[dat$severity=='nonsevere',]
min_corr = 0
prop_greater = 0

te_labs2 <- dat %>% 
  filter(days_since_admission < 100,
         days_since_admission >= 0) %>% 
  mutate(te = patient_num %in% unique(te_patients$patient_num))

#Calculate correlation matrices between lab missing indicators for each time point

sim_mat = matrix(rep(0),ncol(te_labs2)-4,ncol(te_labs2)-4)
mat_list = list()

for (h in 0:max(te_labs2$days_since_admission)){

data1 = te_labs2[which(te_labs2$days_since_admission==h),]

na_stats <- data1 %>% 
  select(- c(days_since_admission,patient_num,te,severity)) %>% 
  is.na() %>% 
  `!` 


for (i in 1:ncol(na_stats)){
  na_stats[,i] <- as.integer(as.logical(na_stats[,i]))
}

sim_mat = matrix(rep(0),ncol(na_stats),ncol(na_stats))

for (i in 1:ncol(na_stats)){
  for (j in 1:ncol(na_stats)){
    if (nrow(na_stats) >= 5) {
      sim_mat[i,j] <- cor(na_stats[,i],na_stats[,j],method="spearman")
    }
  }
}

rownames(sim_mat) <- colnames(na_stats)
colnames(sim_mat) <- colnames(na_stats)

mat_list[[h+1]] = sim_mat

}

#Add correlation values to a dataframe if a lab combination passes the threshold

df <- data.frame(matrix(ncol=0,nrow=length(mat_list)))
df_ind <- data.frame(matrix(ncol=0,nrow=length(mat_list)))
names = list()
final_names = c()
count = 0



for (i in 1:ncol(na_stats)){
  for (j in 1:ncol(na_stats)){
    name1 <- c(row.names(mat_list[[1]])[i],colnames(mat_list[[1]])[j])
    name1 <- do.call(paste, c(as.list(name1), sep = ", "))
    name2 <- c(row.names(mat_list[[1]])[j],colnames(mat_list[[1]])[i])
    name2 <- do.call(paste, c(as.list(name2), sep = ", "))
    if (i != j && !(name1 %in% final_names) && !(name2 %in% final_names)) {
      test_vec = c()
      indices = c()
      ct = 0
      for (h in 1:length(mat_list)){
        if (!(is.na(mat_list[[h]][i,j]))) {
          ct = ct+1
          test_vec[ct] = mat_list[[h]][i,j]
          indices[ct] = h
        }else{
          ct = ct + 1
          test_vec[ct] = test_vec[ct-1]
          indices[ct] = h
        }
      }
      
      if (mean(abs(test_vec) > min_corr) > prop_greater) {
        count = count+1
        final_names[count] = name1
        df[,count] = test_vec
        df_ind[,count] = indices
      }

    }
    }
}
  

colnames(df) <- final_names

results <- list()
results[[1]] <- df
results[[2]] <- mat_list

temporal_nonsevere_penn = df




```


```{r}

#Calculate proportion of existing lab values in binned days since admission (by 50 days) up to 300 days. Stratify by severe vs. non-severe.

#temporal = function(data,bins) {
binby = 30

wide =  patient_obs_wide %>% 
    filter(days_since_admission <= 210,
           days_since_admission >= 0)

wide = wide[c("patient_num","days_since_admission","severity", labsPresent)]

wide = wide[c("patient_num","days_since_admission","Fibrinogen","Troponin_normal","Procalcitonin","FEU","Troponin_high","CRP","Ferritin","LDH","Lymphocyte","PT","Albumin","Neutrophil","AST","ALT","Bilirubin","Leukocytes","Creatinine","severity")]

total_days = max(wide$days_since_admission)
n_bins = as.integer(total_days/binby)
df <- data.frame(matrix(ncol=0,nrow=total_days/binby))

ct = 0
for (i in 1:(total_days/binby)) {
    dat = wide[which(wide$days_since_admission >= (ct+1) & wide$days_since_admission <= (binby+1+ct)),]
    ct = ct+binby
    dat = select(dat,-c(days_since_admission,patient_num,severity))
    for (j in 1:length(lab_names)){
        df[i,j] = (sum(is.na(dat[,j])))/nrow(dat[,j])
    }
}

df_severe = data.frame(matrix(ncol=0,nrow=total_days/binby))

ct = 0
for (i in 1:(total_days/binby)) {
    dat =wide[which(wide$days_since_admission >= (ct+1) & wide$days_since_admission <= (binby+1+ct)),]
    ct = ct+binby
    dat = dat[which(dat$severity=='severe'),]
    dat = select(dat,-c(days_since_admission,patient_num,severity))
    for (j in 1:length(lab_names)){
        df_severe[i,j] = (sum(is.na(dat[,j])))/nrow(dat[,j])
    }
}

df_nonsevere = data.frame(matrix(ncol=0,nrow=total_days/binby))

ct = 0
for (i in 1:(total_days/binby)) {
    dat = dat =wide[which(wide$days_since_admission >= (ct+1) & wide$days_since_admission <= (binby+1+ct)),]
    ct = ct + binby
    dat = dat[which(dat$severity=='nonsevere'),]
    dat = select(dat,-c(days_since_admission,patient_num,severity))
    for (j in 1:length(lab_names)){
        df_nonsevere[i,j] = (sum(is.na(dat[,j])))/nrow(dat[,j])
    }
}


df2 <- data.frame(matrix(ncol=0,nrow=nrow(df)*ncol(df)*3))

count = 0
for (i in 1:length(lab_names)){
    df2[(1+count):(3*nrow(df)+count),1] = rep(colnames(dat)[i],3*nrow(df))
    count = count+3*nrow(df)
}



bin1 = "0-30"
bin2 = "31-60"
bin3 = "61-90"
bin4 = "91-120"
bin5 = "121-150"
bin6 = "151-180"
bin7 = "181-210"



bins = c(bin1,bin2,bin3,bin4,bin5,bin6,bin7)
bins = bins[1:n_bins]

df2[,2] = rep(c(bins,bins,bins),ncol(df))

c1 = rep("All patients", nrow(df))
c2 = rep("Severe patients",nrow(df))
c3 = rep("Non-severe patients",nrow(df))

ctotal = c(c1,c2,c3)
df2[,3] = rep(ctotal,ncol(df))


ct = 0
for (i in 1:ncol(df)){
    df2[(ct+1):(nrow(df)+ct),4] = df[,i]
    ct = ct + nrow(df)
    df2[(ct+1):(nrow(df)+ct),4] = df_severe[,i]
    ct = ct + nrow(df)
    df2[(ct+1):(nrow(df)+ct),4] = df_nonsevere[,i]
    ct= ct + nrow(df)
}

colnames(df2) = c("lab","days_since_admission","name","proportion")


df2$days_since_admission = factor(df2$days_since_admission,levels = bins)

level_order = c("Fibrinogen","Troponin_normal","Procalcitonin","FEU","Troponin_high","CRP","Ferritin","LDH","Lymphocyte","PT","Albumin","Neutrophil","AST","ALT","Bilirubin","Leukocytes","Creatinine")

longhaul_comb_plot = df2 %>%
    ggplot(aes(x = days_since_admission, fill = proportion, y = factor(lab,level_order))) +
    geom_tile(colour = "white", size = 0.2) +
    scale_y_discrete(expand = c(0, 0)) +
    scale_fill_gradient(low = "darkblue", high = "lightgrey") +
    facet_wrap(~name, nrow = 1) +
    labs(
      title = "Proportion of missing lab values over time",
        x = "Binned days since admission",
        y = NULL, fill = "Prop Missing"
    ) +
    
    theme(
        plot.margin=unit(c(1.02,1.6,1,0),"cm"),
        panel.grid.major = element_blank(),
        legend.position = c(1.078, 0.5),
        legend.key.height = unit(1,'cm'),
        legend.key.width=unit(.4,'cm'),
        axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5,size=6),
        axis.ticks.y = element_blank()
    )

longhaul_comb_plot

longhaul_comb_penn = df2

df2_all = df2[df2$name=="All patients",] %>%
  select(-c(name))

longhaul_plot = df2_all %>%
    ggplot(aes(x = days_since_admission, fill = proportion, y = factor(lab,level=level_order))) +
    geom_tile(colour = "white", size = 0.2) +
    scale_y_discrete(expand = c(0, 0)) +
    scale_fill_gradient(low = "darkblue", high = "lightgrey") +
    labs(
      title = "Proportion of missing lab values over time",
        x = "Binned days since admission",
        y = NULL, fill = "Prop missing"
    ) +
    
    theme(
        plot.margin=unit(c(1.02,1.6,1,0),"cm"),
        panel.grid.major = element_blank(),
        legend.position = c(1.078, 0.5),
        legend.key.height = unit(1,'cm'),
        legend.key.width=unit(.4,'cm'),
        axis.text.x = element_text(angle = 0, hjust = 1, vjust = 0.5,size=9),
        axis.ticks.y = element_blank()
    )

longhaul_plot

longhaul_penn = df2_all













#Calculate proportion of existing lab values in days since admission up to 20 days. Stratify by severe vs. non-severe.
binby = 1

wide =  patient_obs_wide %>% 
    filter(days_since_admission <= 20,
           days_since_admission >= 0)

total_days = max(wide$days_since_admission)
df <- data.frame(matrix(ncol=0,nrow=total_days/binby))

ct = 0
for (i in 1:(total_days)) {
    dat = wide[which(wide$days_since_admission >= (ct+1) & wide$days_since_admission <= (binby+1+ct)),]
    ct = ct+binby
    dat = select(dat,-c(days_since_admission,patient_num,severity))
    for (j in 1:length(lab_names)){
        df[i,j] = (sum(is.na(dat[,j])))/nrow(dat[,j])
    }
}

df_severe = data.frame(matrix(ncol=0,nrow=total_days/binby))

ct = 0
for (i in 1:(total_days/binby)) {
    dat =wide[which(wide$days_since_admission >= (ct+1) & wide$days_since_admission <= (binby+1+ct)),]
    ct = ct+binby
    dat = dat[which(dat$severity=='severe'),]
    dat = select(dat,-c(days_since_admission,patient_num,severity))
    for (j in 1:length(lab_names)){
        df_severe[i,j] = (sum(is.na(dat[,j])))/nrow(dat[,j])
    }
}

df_nonsevere = data.frame(matrix(ncol=0,nrow=total_days/binby))

ct = 0
for (i in 1:(total_days/binby)) {
    dat = dat =wide[which(wide$days_since_admission >= (ct+1) & wide$days_since_admission <= (binby+1+ct)),]
    ct = ct + binby
    dat = dat[which(dat$severity=='nonsevere'),]
    dat = select(dat,-c(days_since_admission,patient_num,severity))
    for (j in 1:length(lab_names)){
        df_nonsevere[i,j] = (sum(is.na(dat[,j])))/nrow(dat[,j])
    }
}


df2 <- data.frame(matrix(ncol=0,nrow=nrow(df)*ncol(df)*3))

count = 0
for (i in 1:length(lab_names)){
    df2[(1+count):(3*nrow(df)+count),1] = rep(colnames(dat)[i],3*nrow(df))
    count = count+3*nrow(df)
}


days = seq(1,20,1)
df2[,2] = rep(c(days,days,days),ncol(df))

c1 = rep("All patients", nrow(df))
c2 = rep("Severe patients",nrow(df))
c3 = rep("Non-severe patients",nrow(df))

ctotal = c(c1,c2,c3)
df2[,3] = rep(ctotal,ncol(df))


ct = 0
for (i in 1:ncol(df)){
    df2[(ct+1):(nrow(df)+ct),4] = df[,i]
    ct = ct + nrow(df)
    df2[(ct+1):(nrow(df)+ct),4] = df_severe[,i]
    ct = ct + nrow(df)
    df2[(ct+1):(nrow(df)+ct),4] = df_nonsevere[,i]
    ct= ct + nrow(df)
}


colnames(df2) = c("lab","days_since_admission","name","proportion")
df2$days_since_admission = factor(df2$days_since_admission,levels = bins)


level_order = c("Fibrinogen","Troponin_normal","Procalcitonin","FEU","Troponin_high","CRP","Ferritin","LDH","Lymphocyte","PT","Albumin","Neutrophil","AST","ALT","Bilirubin","Leukocytes","Creatinine")

days = seq(1,20,1)
df2[,2] = rep(c(days,days,days),ncol(df))

shorthaul_comb_penn = df2

shorthaul_comb_plot = df2 %>%
    ggplot(aes(x = days_since_admission, fill = proportion, y = factor(lab, level_order))) +
    geom_tile(colour = "white", size = 0.2) +
    scale_y_discrete(expand = c(0, 0)) +
    scale_fill_gradient(low = "darkblue", high = "lightgrey") +
    facet_wrap(~name, nrow = 1) +
    labs(title = "Proportion of missing lab values over time",
        x = "Binned days since admission",
        y = NULL, fill = "Prop missing"
    ) +
    
    theme(
        plot.margin=unit(c(1.02,1.6,1,0),"cm"),
        panel.grid.major = element_blank(),
        legend.position = c(1.078, 0.5),
        legend.key.height = unit(1,'cm'),
        legend.key.width=unit(.4,'cm'),
        axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5,size=6),
        axis.ticks.y = element_blank()
    )

shorthaul_comb_plot

df2_all = df2[df2$name=="All patients",] %>%
  select(-c(name))

shorthaul_penn = df2_all

shorthaul_plot = df2_all %>%
    ggplot(aes(x = days_since_admission, fill = proportion, y = factor(lab, level_order))) +
    geom_tile(colour = "white", size = 0.2) +
    scale_y_discrete(expand = c(0, 0)) +
    scale_fill_gradient(low = "darkblue", high = "lightgrey") +
    labs(
      title = "Proportion of missing lab values over time",
        x = "Binned days since admission",
        y = NULL, fill = "Missing"
    ) +
    
    theme(
        plot.margin=unit(c(1.02,1.6,1,0),"cm"),
        panel.grid.major = element_blank(),
        legend.position = c(1.078, 0.5),
        legend.key.height = unit(1,'cm'),
        legend.key.width=unit(.4,'cm'),
        axis.text.x = element_text(angle = 0, hjust = 1, vjust = 0.5,size=9),
        axis.ticks.y = element_blank()
    )

shorthaul_plot 

```



```{R}
# check NAs in the Wide format

#Create True / False dataframe for whether or not a lab is missing for each observation

na_stats <- patient_obs_wide %>%
  select(-c(patient_num, days_since_admission)) %>%
  is.na() %>%
  `!`()

#Create new dataframe containing number of values and proportion of values existing per lab 

na_df <- data.frame(
  value_existed = colSums(na_stats),
  prop_existed = colMeans(na_stats)
) %>%
  rownames_to_column("lab") %>%
  mutate(
    prop_na = 1 - prop_existed,
    lab = fct_reorder(lab, value_existed)
  )

#Plot number of values per lab

n_values <- na_df %>%
  ggplot(aes(x = value_existed, y = lab)) +
  geom_col() +
  labs(x = "Number of values", y = NULL)

#Plot proportion of values per lab. Valid value indicates existing values. 

na_prob <- na_df %>%
  rename("Valid value" = prop_existed, "NA" = prop_na) %>%
  pivot_longer(c(`Valid value`, `NA`)) %>%
  ggplot(aes(x = value, y = lab, fill = name)) +
  geom_col() +
  scale_fill_discrete(guide = guide_legend(reverse = TRUE)) +
  labs(x = "Proportion", y = NULL) +
  # guides(fill = guide_legend(reverse = TRUE))
  theme(
    axis.text.y = element_blank(),
    legend.key.width = unit(6, "mm"),
    legend.key.height = unit(4, "mm"),
    legend.position = "bottom"
  )

plot_grid(n_values, na_prob, nrow = 1, axis = "b", align = "h")

penn_na_df <- na_df
```


```{r}

#Keep the patient num and days_since_admission variables, and convert the individual lab name variables into one single variable where each observation is the name of the lab, and create another variable for the corresponding lab values. 

patient_obs_long <- patient_obs_wide %>%
  pivot_longer(-c(patient_num, days_since_admission, severity),
    names_to = "lab", values_to = "value",
    values_drop_na = TRUE
  )
```


```{r fig.show='hide'}
# number of patients per lab value

#For an individual lab, obtain number of lab observations per patient. Plot a histogram of the number of lab observations for each patient. Create dataframe containing counts and density for each lab.

get_pat_labs <- function(labi) {
  patients_labs <- patient_obs_long %>%
    filter(lab == labi) %>%
    count(patient_num) %>%
    pull(n) %>%
    hist(., breaks = seq(0, max(.), 1), main = labi)

  patients_labs[[1]] <- patients_labs[[1]][-1]
  data.frame(
    do.call(cbind.data.frame, patients_labs[1:3]),
    lab = labi
  )
}

#Run function for each lab and bind the rows from each dataframe

patient_lab <- lapply(unique(patient_obs_long$lab), get_pat_labs) %>%
  bind_rows()

penn_patient_lab <- patient_lab


#Replicate each row by the length of the dataframe

melt_patient_lab <- patient_lab[rep(1:nrow(patient_lab), patient_lab$counts), ]
```

```{r}
melt_patient_lab %>%
  filter(breaks < 30) %>%
  mutate(lab = fct_infreq(lab)) %>%
  ggplot(aes(x = breaks, y = lab, fill = lab, height = ..count..)) +
  # geom_density_ridges(stat = "identity", scale = 2) +
  geom_ridgeline(stat = "binline", binwidth = 1, scale = 0.001) +
  # scale_color_viridis_d(option = 'C') +
  scale_fill_viridis_d(option = "C", guide = FALSE) +
  labs(y = NULL) +
  # coord_flip() +
  # facet_wrap(~ lab, scales = 'free') +
  NULL
```


## Number of observation (days) per patient
```{R}
days_count_min_max <-
  # multiple_imps %>%
  patient_obs_wide %>%
  group_by(patient_num, severity) %>%
  summarise(
    n_values = n_distinct(days_since_admission),
    min_day = min(days_since_admission),
    max_day = max(days_since_admission),
    .groups = "drop"
  ) %>%
  # left_join(demo_raw, by = "patient_num") %>%
  # mutate(time_obs = max_day - min_day,
  #        severity = factor(severe)) %>%
  # select(-patient_num) %>%
  add_count(severity, name = "n_severity") %>%
  {
    .
  }

penn_agg_n_values <- days_count_min_max %>%
  count(severity, n_severity, n_values,
    name = "n_nvals"
  )
penn_agg_max_day <- days_count_min_max %>%
  count(severity, n_severity, max_day,
    name = "n_maxday"
  )

penn_agg_n_values %>%
  ggplot(aes(x = n_nvals)) +
  geom_bar()

(n_severe <- sum(days_count_min_max$severity == "severe"))
(n_nonsevere <- sum(days_count_min_max$severity == "nonsevere"))
```

## Histogram of the number of days with at least one observation
```{R}
penn_agg_n_values %>%
  ggplot(aes(x = n_values, y = n_nvals, fill = severity)) +
  geom_col(alpha = 0.5) +
  scale_fill_brewer(palette = "Dark2", direction = -1) +
  labs(
    fill = "Severe?",
    x = "Number of days with data",
    y = "Count"
  )
```

## Histogram of length of stay
i.e. last day with observation-first day with observation

We need to check for readmission here.
```{R}
penn_agg_max_day %>%
  ggplot(aes(x = max_day, y = n_maxday, fill = severity)) +
  geom_col(alpha = 0.5) +
  scale_fill_brewer(palette = "Dark2", direction = -1) +
  labs(
    fill = "Severe?",
    x = "Number of days with data",
    y = "Count"
  )
```

## Analyze missingness and frequency of measures for each lab

```{r}

#Count the number of observations for each individual patient.  Then count the number of patients that have x severe observations and z nonsevere observations for a given lab (for the range of x and z observations for a given lab). Add a column for both severities. Add another column for the proportion of severe patients that have x severe observations for a given lab out of all severe patients. Do this for non-severe and both severities. 

per_lab <- patient_obs_long %>%
  group_by(lab, patient_num, severity) %>%
  count(name = "n_obs") %>%
  ungroup() %>%
  group_by(lab, severity) %>%
  count(n_obs) %>%
  ungroup() %>%
  pivot_wider(names_from = severity, values_from = n, values_fill = 0) %>%
  mutate(both_severities = nonsevere + severe) %>%
  mutate(
    prop_nonsevere = nonsevere / n_nonsevere,
    prop_severe = severe / n_severe,
    prop_both = both_severities / nrow(days_count_min_max)
  )

lab_medians <-
  patient_obs_long %>%
  add_count(lab, name = "total_obs") %>%
  group_by(lab) %>%
  mutate(total_patients = length(unique(patient_num))) %>%
  add_count(patient_num, name = "n_obs_patients") %>%
  mutate(
    median_obs_per_patient = median(n_obs_patients),
    n_greater0 = n_obs_patients > median_obs_per_patient,
    n_greater1 = n_obs_patients > median_obs_per_patient + 1,
    n_greater2 = n_obs_patients > median_obs_per_patient + 2
  ) %>%
  group_by(severity) %>%
  mutate(each_med_obs_per_patient = median(n_obs_patients)) %>%
  ungroup(severity) %>%
  select(-c(days_since_admission, value)) %>%
  distinct() %>%
  group_by(lab) %>%
  mutate(across(contains("n_greater"), sum)) %>%
  select(-c(n_obs_patients, patient_num)) %>%
  distinct() %>%
  pivot_wider(names_from = severity, values_from = each_med_obs_per_patient) %>%
  rename(
    "median_obs_per_severe_patient" = severe,
    "median_obs_per_non_severe_patient" = nonsevere
  ) %>%
  select(lab, total_obs, total_patients, starts_with("med"), starts_with("n_"))

lab_medians %>%
  datatable(rownames = FALSE)
```


`n_greater0` shows the number of patients who had more observations than the median.
`n_greater1` shows the number of patients who had more observations than the median + 1.
`n_greater2` shows the number of patients who had more observations than the median + 2.

```{r eval=FALSE, include=FALSE}
lab_medians %>%
  select(lab, total_obs, total_patients) %>%
  pivot_longer(-lab) %>%
  ggplot(aes(x = value, y = fct_reorder(lab, value))) +
  geom_col() +
  facet_grid(cols = vars(name), scales = "free_x", space = "free") +
  labs(y = NULL)
```

In the figure below:

- Grey dash line: `Reference Low`
- Grey solid line: `Reference High`
- Black dash line: `lower bound outlier` (QC)
- Black solid line: `upper bound outlier` (QC)

```{r fig.width=9, fig.height=11}
patient_obs_long %>%
  left_join(lab_bounds, by = c("lab" = "short_name")) %>%
  ggplot(aes(y = severity, x = value, fill = severity)) +
  geom_violin() +
  scale_fill_brewer(palette = "Dark2", guide = guide_legend(reverse = TRUE)) +
  labs(y = NULL, x = NULL) +
  geom_vline(aes(xintercept = `Reference Low`), linetype = "dashed", color = "grey") +
  geom_vline(aes(xintercept = `Reference High`), color = "grey") +
  geom_vline(aes(xintercept = LB), linetype = "dashed") +
  geom_vline(aes(xintercept = UB)) +
  facet_wrap(~lab, scales = "free", ncol = 2, strip.position = "left") +
  theme(axis.text.y = element_blank())
```

## Missing data heatmap

"Binned" heatmap

```{r fig.width=12}

#Generate a heatmap in which darker purple colors indicate a higher proportion of patients in a given bin (detailing the number of values a patient has for a given lab). 

per_lab %>%
  mutate(obs_bin = cut(
    n_obs,
    breaks = c(0:15, 20, 30, max(n_obs))
  )) %>%
  group_by(lab, obs_bin) %>%
  summarise(
    both_severities = sum(both_severities),
    severe = sum(severe),
    nonsevere = sum(nonsevere),
    .groups = "drop"
  ) %>%
  select(lab, obs_bin, both_severities, severe, nonsevere) %>%
  pivot_longer(c(both_severities, severe, nonsevere)) %>%
  mutate(name = name %>% fct_recode(
    "All patients" = "both_severities",
    "Severe patients" = "severe",
    "Non-severe patients" = "nonsevere"
  )) %>%
  ggplot(aes(x = obs_bin, fill = value, y = fct_reorder(lab, value))) +
  geom_tile(colour = "white", size = 0.2) +
  geom_text(aes(label = value), colour = "white", size = 2) +
  scale_y_discrete(expand = c(0, 0)) +
  scale_fill_gradient(low = "lightgrey", high = "darkblue") +
  facet_wrap(~name, nrow = 1) +
  labs(
    x = "Binned number of values a patient has for each lab",
    y = NULL, fill = "# patients"
  ) +
  theme(
    panel.grid.major = element_blank(),
    legend.position = c(0.93, 0.2),
    axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5),
    axis.ticks.y = element_blank()
  )
```


```{r fig.width=12}

bin_nobs = per_lab %>%
  mutate(obs_bin = cut(n_obs, breaks = c(0:15, 20, 30, max(n_obs)))) %>%
  group_by(lab, obs_bin) %>%
  summarise(
    prop_both = sum(prop_both, na.rm = TRUE),
    prop_severe = sum(prop_severe, na.rm = TRUE),
    prop_nonsevere = sum(prop_nonsevere, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  select(lab, obs_bin, prop_both, prop_severe, prop_nonsevere) %>%
  pivot_longer(c(prop_both, prop_severe, prop_nonsevere)) %>%
  mutate(name = name %>% fct_recode(
    "Compared to all patients" = "prop_both",
    "Compared to all severe patients" = "prop_severe",
    "Compared to all non-severe patients" = "prop_nonsevere"
  ))
binnobs_plot = bin_nobs %>% ggplot(aes(x = obs_bin, fill = value, y = fct_reorder(lab, value))) +
  geom_tile(colour = "white", size = 0.2) +
  geom_text(aes(label = round(value, 2)), colour = "white", size = 2) +
  scale_y_discrete(expand = c(0, 0)) +
  scale_fill_gradient(
    low = "lightgrey", high = "darkblue",
    labels = scales::percent_format(accuracy = 1L)
  ) +
  facet_wrap(~name, nrow = 1) +
  labs(
    x = "Binned number of values a patient has for each lab",
    y = NULL, fill = "% patients"
  ) +
  theme(
    panel.grid.major = element_blank(),
    legend.position = c(0.93, 0.2),
    axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5),
    axis.ticks.y = element_blank()
  )

bin_nobs_penn = bin_nobs
binnobs_plot

```

Denominator: total number of patients, total number of non-severe patients,
and total number of severe patients, respectively.

```{r}
per_lab %>%
  select(lab, n_obs, severe, nonsevere) %>%
  filter(n_obs <= 90) %>%
  pivot_longer(c(severe, nonsevere)) %>%
  mutate(
    lab = fct_reorder(lab, n_obs),
    name = name %>% fct_recode(
      "Severe patients" = "severe",
      "Non-severe patients" = "nonsevere"
    )
  ) %>%
  ggplot(aes(x = n_obs, fill = name, y = value)) +
  geom_col() +
  scale_fill_brewer(palette = "Dark2", direction = -1) +
  facet_wrap(~lab, scales = "free") +
  labs(
    x = "Number of values a patient has for each lab",
    y = NULL, fill = "# patients"
  ) +
  theme(
    panel.grid.major = element_blank(),
    legend.position = c(0.9, 0.2),
    axis.ticks.y = element_blank()
  )
```


```{r}
sessionInfo()
```

```{r}
save(df_prop_penn,df_num_penn,df_prop_Sex_penn,df_prop_Severity_penn,temporal_penn,temporal_severe_penn,temporal_nonsevere_penn,longhaul_comb_penn,longhaul_penn,shorthaul_comb_penn,shorthaul_penn,bin_nobs_penn,
  file = "results/penn-results-quantify-missingness.Rdata"
)

ggsave('figs/prop_plot_penn.png', prop_plot)
ggsave('figs/num_plot_penn.png',num_plot)
ggsave('figs/longhaul_comb_plot_penn.png',longhaul_comb_plot)
ggsave('figs/longhaul_plot_penn.png',longhaul_plot)
ggsave('figs/shorthaul_comb_plot_penn.png',shorthaul_comb_plot)
ggsave('figs/shorthaul_plot_penn.png',shorthaul_plot)
ggsave('figs/binnobs_plot_penn.png',binnobs_plot)
ggsave('figs/prop_plot_diff_sex_penn.png',prop_plot_diff_sex_penn)
ggsave('figs/prop_plot_diff_severity_penn.png',prop_plot_diff_severity_penn)

#

```
